<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Edit Bike | </title>
    <include src="./partials/mainhead.html"> </include>
    <script src="./assets/js/main.js"></script>

    <script>
        // blow Up modal
        $(document).ready(function() {
            
            const openModalButton = document.getElementById("openModal");
                const closeModalButton = document.getElementById("closeModal");
                const modal = document.getElementById("modal");
    
                // Open Modal
                openModalButton.addEventListener("click", () => {
                modal.style.display = "flex"; // Show the modal
                const modalContent = modal.querySelector(".modal-content");
                modalContent.style.animation = "blowUp 0.3s ease-out forwards"; // Blow up animation
                });
    
                // Close Modal
                closeModalButton.addEventListener("click", () => {
                const modalContent = modal.querySelector(".modal-content");
                modalContent.style.animation = "goBack 0.3s ease-out forwards"; // Go back animation
    
                // Hide the modal after the animation completes
                setTimeout(() => {
                    modal.style.display = "none";
                }, 300); // Match the duration of the animation
                });
    
    
                const canvas = document.getElementById("signature_pad");
                const clearButton = document.getElementById("clear");
                const saveButton = document.getElementById("save");
                
                // Initialize Signature Pad
                const signaturePad = new SignaturePad(canvas);
                
                // Clear the canvas
                clearButton.addEventListener("click", () => {
                signaturePad.clear();
                });
                
                // Save the signature as an image
                saveButton.addEventListener("click", () => {
                if (signaturePad.isEmpty()) {
                    alert("Please provide a signature first.");
                } else {
                    const dataURL = signaturePad.toDataURL(); // Get signature as a data URL
                    console.log(dataURL); // Log the data URL to the console
                    alert("Signature saved! Check the console for the data URL.");
                
                    // Optionally, download the image
                    const link = document.createElement("a");
                    link.href = dataURL;
                    link.download = "signature.png";
                    link.click();
                }
                });
            })
    </script>
  </head>
  <body
    x-data="{ page: 'Consolidate shipment', 'loaded': true, 'darkMode': false, 'stickyMenu': false, 'sidebarToggle': false, 'scrollTop': false }"
    x-init="
         darkMode = JSON.parse(localStorage.getItem('darkMode'));
         $watch('darkMode', value => localStorage.setItem('darkMode', JSON.stringify(value)))"
    :class="{'dark bg-gray-900': darkMode === true}"
  >
    <!-- ===== Preloader Start ===== -->
    <include src="./partials/preloader.html"></include>
    <!-- ===== Preloader End ===== -->

    <!-- ===== Page Wrapper Start ===== -->
    <div class="flex h-screen overflow-hidden">
      <!-- ===== Sidebar Start ===== -->
      <include src="./partials/sidebar.html"></include>
      <!-- ===== Sidebar End ===== -->

      <!-- ===== Content Area Start ===== -->
      <div
        class="relative flex flex-1 flex-col overflow-y-auto overflow-x-hidden"
      >
        <!-- Small Device Overlay Start -->
        <include src="./partials/overlay.html" />
        <!-- Small Device Overlay End -->

        <!-- ===== Header Start ===== -->
        <include src="./partials/header.html" />
        <!-- ===== Header End ===== -->

        <!-- ===== Main Content Start ===== -->
        <main>
          <div class="mx-auto max-w-screen-2xl p-4 md:p-6">
            <!-- Breadcrumb Start -->
            <div x-data="{ pageName: `Consolidate Shipment`}">
              <include src="./partials/breadcrumb.html" />
            </div>
            <!-- Breadcrumb End -->

               <!-- Modal -->
               <div id="modal" class="modal">
                <div class="modal-content">
                <span id="closeModal" class="close">&times;</span>
                <h2>Sign and Save, then upload the signed signature</h2>
                <div id="signature-pad" class="signature-pad">
                    <canvas id="signature_pad" width="400" height="200"></canvas>
                    <div class="buttons">
                        <button type="button" id="clear" class="focus:outline-none text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-900">Reset</button>

                        <button type="button" id="save" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800">Save</button>
                    </div>
                </div>
                </div>
            </div>


            <div class="rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03]">
              <div x-data="stepperForm()" class="w-full mx-auto px-4">
                <ol class="flex items-center justify-between w-full p-3 text-sm font-medium text-center text-gray-500 bg-white border border-gray-200 rounded-lg shadow-xs dark:text-gray-400 sm:text-base dark:bg-gray-800 dark:border-gray-700 sm:p-4 rtl:space-x-reverse">
                    <li class="flex-1 flex items-center justify-center" :class="{ 'text-blue-600 dark:text-blue-500': step === 1, 'text-gray-500 dark:text-gray-400': step !== 1 }">
                        <span class="flex items-center justify-center w-6 h-6 text-xs font-bold border rounded-full"
                            :class="{ 'border-blue-600 bg-blue-600 text-white dark:border-blue-500': step === 1, 'border-gray-500 dark:border-gray-400': step !== 1 }">
                            1
                        </span>
                        <span class="ml-2 hidden sm:inline">Basic Info</span>
                    </li>
                
                    <li class="flex-1 flex items-center justify-center" :class="{ 'text-blue-600 dark:text-blue-500': step === 2, 'text-gray-500 dark:text-gray-400': step !== 2 }">
                        <span class="flex items-center justify-center w-6 h-6 text-xs font-bold border rounded-full"
                            :class="{ 'border-blue-600 bg-blue-600 text-white dark:border-blue-500': step === 2, 'border-gray-500 dark:border-gray-400': step !== 2 }">
                            2
                        </span>
                        <span class="ml-2 hidden sm:inline">Charges</span>
                    </li>

                    <li class="flex-1 flex items-center justify-center" :class="{ 'text-blue-600 dark:text-blue-500': step === 3, 'text-gray-500 dark:text-gray-400': step !== 3 }">
                        <span class="flex items-center justify-center w-6 h-6 text-xs font-bold border rounded-full"
                            :class="{ 'border-blue-600 bg-blue-600 text-white dark:border-blue-500': step === 3, 'border-gray-500 dark:border-gray-400': step !== 3 }">
                            3
                        </span>
                        <span class="ml-2 hidden sm:inline">Delivery Mode</span>
                    </li>

                    <li class="flex-1 flex items-center justify-center" :class="{ 'text-blue-600 dark:text-blue-500': step === 4, 'text-gray-500 dark:text-gray-400': step !== 4 }">
                        <span class="flex items-center justify-center w-6 h-6 text-xs font-bold border rounded-full"
                            :class="{ 'border-blue-600 bg-blue-600 text-white dark:border-blue-500': step === 4, 'border-gray-500 dark:border-gray-400': step !== 4 }">
                            4
                        </span>
                        <span class="ml-2 hidden sm:inline">Backup Docs</span>
                    </li>
                </ol>
                
            
                <form class="mt-6 bg-white p-6 rounded-lg shadow dark:bg-gray-800 w-full border border-gray-200 dark:border-gray-700" @submit.prevent="saveAndSubmit" enctype="multipart/form-data" id="ConsolidateShipmentForm">
                    <!-- Step 1: Basic Info -->
                    <div x-show="step === 1" >
                        <div id="" class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-6">
                            <!-- <div>
                                <label class="block text-gray-700 dark:text-gray-300">Customer Name</label>
                                <input type="text" x-model="formData.customer_name" name="customer_name" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="">
                            </div> -->
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300">Consolidation Type <span class="text-red-600 dark:text-red-500">*</span></label>
                                <select required x-model="formData.consolidation_type" name="consolidation_type" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    <option value="" selected disabled>Select Type</option>
                                    <option value="Personal">Personal</option>
                                    <option value="Commercial">Commercial</option>
                                </select>
                            </div>
                            
                            <div id="">
                                <label class="block text-gray-700 dark:text-gray-300">Consolidate For</label>
                                <input type="text" x-model="formData.consolidated_for" name="consolidated_for" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                            </div>
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300">Customer Email</label>
                                <input type="text" x-model="formData.customer_email" name="customer_email" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="">
                            </div>
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300">Customer Phone</label>
                                <input type="text" x-model="formData.customer_phone" name="customer_phone" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="">
                            </div>
                        </div>

                        <div id="" class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-6">
                            <div id="">
                                <label class="block text-gray-700 dark:text-gray-300">Reciever Name</label>
                                <input type="text" x-model="formData.receiver_name" name="receiver_name" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                            </div>
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300">Reciever Address</label>
                                <input type="text" x-model="formData.receiver_address" name="receiver_address" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="">
                            </div>
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300">Reciever Phone</label>
                                <input type="text" x-model="formData.receiver_phone" name="receiver_phone" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="">
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300">Reciever Email <span class="text-red-600 dark:text-red-500">*</span></label>
                                <input required type="text" x-model="formData.receiver_email" name="receiver_email" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="">
                            </div>
                        </div>

                        
                        <div id="" class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-6">
                            
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300">Origin Warehouse</label>
                                <input x-model="formData.origin_warehouse" name="origin_warehouse" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300">Destination Warehouse</label>
                                <input x-model="formData.destination_warehouse" name="destination_warehouse" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                            </div>
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300">Departure Date</label>
                                <input type="text" x-model="formData.expected_departure_date" name="expected_departure_date" id="expected_departure_date" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="">
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300">Arrival Date</label>
                                <input type="text" id="expected_arrival_date" x-model="formData.expected_arrival_date" id="expected_arrival_date" name="expected_arrival_date" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="">
                            </div>
                        </div>

                        <div id="" class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-6">
                            <div id="">
                                <label class="block text-gray-700 dark:text-gray-300">Total Weight</label>
                                <input type="text" x-model="formData.total_weight" @input="formData.total_weight = formData.total_weight.replace(/[^0-9.]/g, '')" name="total_weight"  class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white numberOnly" @change="calculateTotalWeight()"/>
                            </div>
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300">Total Shipping Cost</label>
                                <input type="text" x-model="formData.total_shipping_cost" name="total_shipping_cost" readonly class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="">
                            </div>
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300">Handling Fee</label>
                                <input type="text" x-model="formData.handling_fee" name="handling_fee" id="handling_fee" readonly class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" @change="calculateTotalWeight()" placeholder="">
                            </div>
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300 flex">Signature <span id="openModal" class="">
                                    <svg xmlns="http://www.w3.org/2000/svg" style="margin-left: 10px;" width="16" height="16" fill="currentColor" class="bi bi-pen-fill text-blue-600 cursor-pointer dark:text-white" viewBox="0 0 16 16">
                                        <path d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001"/>
                                      </svg>
                                      
                                </span></label>
                                <input type="file" x-model="formData.proof_of_delivery_path" id="proof_of_delivery_path" name="proof_of_delivery_path" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="">
                            </div>
                            
                        </div>

                        <div id="" class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-6">
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300">Payment Status <span class="text-red-500 dark:text-red-400">*</span></label>
                                <select required x-model="formData.payment_status" name="payment_status" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    <option value="" selected disabled>Select Type</option>
                                    <option value="Paid">Paid</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Partially Paid">Partially Paid</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300">Payment Method</label>
                                <select x-model="formData.payment_method" name="payment_method" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    <option value="" selected disabled>Select Type</option>
                                    <option value="Cash">Cash</option>
                                    <option value="Card">Card</option>
                                    <option value="Transfer">Transfer</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            
                            <div id="">
                                <label class="block text-gray-700 dark:text-gray-300">Internal Notes</label>
                                <textarea cols="1" rows="1" type="text" x-model="formData.internal_notes" name="internal_notes" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" > </textarea>
                            </div>

                        </div>

                    </div>


                    <!-- Step 2: Charges -->
                    <div x-show="step === 2">
                        <template x-for="(charge, index) in formData.charges" :key="index">
                            <div class="mb-6 chargecalc">
                                <div class="flex justify-end mb-2">
                                    <span @click="addCharge()" 
                                          class="ml-2 cursor-pointer text-lg font-bold text-blue-600 dark:text-blue-400">
                                        +
                                    </span>
                                    <span @click="removeCharge(index)" 
                                          class="ml-2 cursor-pointer text-lg font-bold text-blue-600 dark:text-red-500">
                                        x
                                    </span>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                                    <div>
                                        <label class="block text-gray-700 dark:text-gray-300">Charge Type</label>
                                        <select x-model="charge.charge_type" name="charge_type[]" 
                                                class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                            <option value="" selected disabled></option>
                                            <option value="drayage">Drayage</option>
                                            <option value="fuel_surcharge">Fuel Surcharge</option>
                                            <option value="admin_fee">Admin Fee</option>
                                            <option value="attempted_pickup">Attempted Pickup</option>
                                            <option value="bonded_cargo_pickup">Bonded Cargo Pickup</option>
                                            <option value="bonded_cargo_charge">Bonded Cargo Charge</option>
                                            <option value="chasis_rental">Chasis Rental</option>
                                            <option value="chasis_rental">Chasis Rental</option>
                                            <option value="chasis_split">Chasis Split</option>
                                            <option value="chasis_stack">Chasis Stack</option>
                                            <option value="demurage">Demurage</option>
                                            <option value="driver_assistance">Driver Assistance</option>
                                            <option value="drop_charge">Drop Charge</option>
                                            <option value="dry_run">Dry Run</option>
                                            <option value="freight">Freight</option>
                                            <option value="hauling_refrigerated_cargo">Hauling Refrigerated Cargo</option>
                                            <option value="harzadous_material">Harzardous Material</option>
                                            <option value="maintainance_repair">Maintainance & Repair</option>
                                            <option value="other">Other</option>
                                            <option value="Overweight">Overweight</option>
                                            <option value="per_diem">Per Diem</option>
                                            <option value="permits">Permits</option>
                                            <option value="prepull">Prepull</option>
                                            <option value="deliver">Delivery Charge</option>
                                            <option value="shipping">SHIPPING</option>
                                            <option value="scale load">Scale Load</option>
                                            <option value="spot_empty">Spot Empty</option>
                                            <option value="stop_off">Stop Off</option>
                                            <option value="storage">Storage</option>
                                            <option value="toll">Toll</option>
                                            <option value="triaxle">Triaxle</option>
                                            <!-- <option value="pickup">Pickup</option>
                                            <option value="pickup loaded">Pickup Loaded</option> -->
                                            <!-- Other options... -->
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 dark:text-gray-300">Comment</label>
                                        <input type="text" x-model="charge.comment" name="comment[]" 
                                               class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 dark:text-gray-300">Units</label>
                                        <input type="number" x-model="charge.units" @input="calculateAmount(charge)" 
                                               name="units[]" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 dark:text-gray-300">Rate</label>
                                        <input type="number" x-model="charge.rate" @input="calculateAmount(charge)" 
                                               name="rate[]" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                </div>
                    
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div>
                                        <label class="block text-gray-700 dark:text-gray-300">Amount</label>
                                        <input type="number" x-model="charge.amount" name="amount[]" readonly 
                                               class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 dark:text-gray-300">Discount</label>
                                        <input type="number" x-model="charge.discount" @input="calculateTotals()" 
                                               name="discount[]" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 dark:text-gray-300">Internal Note</label>
                                        <input type="text" x-model="charge.internal_notes_charges" name="internal_notes_charges[]" 
                                               class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                </div>
                            </div>
                        </template>
                    
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300">Total</label>
                                <input type="number" x-model="formData.total" name="total" readonly 
                                       class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300">Total Discount</label>
                                <input type="number" x-model="formData.total_discount" name="total_discount" readonly 
                                       class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300">Net Total</label>
                                <input type="number" x-model="formData.net_total" name="net_total" readonly 
                                       class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            </div>
                        </div>
                        
                </div>



                    <!-- Step 3: Assign Driver -->
                    <div x-show="step === 3" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- <div id="">
                            <label class="block text-gray-700 dark:text-gray-300">Drivers Assigned</label>
                            
                            <select x-model="formData.driver_id" name="driver_id" id="driver_id" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="" selected disabled>Select Type</option>
                                <option value="">List of Drivers</option>
                            </select>
                        </div> -->
                        <div x-data="{ formData: { delivery_type: '', driver_id: '' } }">

                            <div class="flex items-center space-x-4 mt-6">
                                <!-- Radio Option 1 -->
                                <label class="flex items-center space-x-2">
                                    <input type="radio" x-model="formData.delivery_type" name="delivery_type" value="Carrier"
                                    @click="formData.carrier_id = ''"
                                        class="text-blue-500 dark:bg-gray-700 dark:border-gray-600">
                                    <span class="text-gray-700 dark:text-gray-300">Carrier?</span>
                                </label>
                        
                                <!-- Radio Option 2 -->
                                <label class="flex items-center space-x-2">
                                    <input type="radio" x-model="formData.delivery_type" name="delivery_type" value="Truck"
                                    @click="formData.driver_id = ''" 
                                        class="text-blue-500 dark:bg-gray-700 dark:border-gray-600">
                                    <span class="text-gray-700 dark:text-gray-300">Truck</span>
                                </label>
                                <!-- Radio Option 3 Bike -->
                                <!-- <label class="flex items-center space-x-2">
                                    <input type="radio" x-model="formData.delivery_type" name="delivery_type" value="Bike"
                                        class="text-blue-500 dark:bg-gray-700 dark:border-gray-600">
                                    <span class="text-gray-700 dark:text-gray-300">Bike</span>
                                </label> -->
                            </div>
                        
                            <!-- Show when "Truck" is selected -->
                            <div x-show="formData.delivery_type === 'Truck'" class="isDrive mt-4">
                                <label class="block text-gray-700 dark:text-gray-300">Assign Driver</label>
                                <select x-model="formData.driver_id" name="driver_id" id="driver_id"
                                    class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    <option value="" selected disabled>Choose Driver</option>
                                
                                </select>
                            </div>
                        
                            <!-- Show when "Carrier" is selected -->
                            <div x-show="formData.delivery_type === 'Carrier'" class="isTruc mt-4">
                                <label class="block text-gray-700 dark:text-gray-300">Assign Carrier</label>
                                <select x-model="formData.carrier_id" name="carrier_id" id="carrier_id"
                                    class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" id="carrier_driver">
                                    <!-- <option value="" selected disabled>Choose Carrier</option>
                                    <option value="1">John Doe</option>
                                    <option value="2">Billy John</option>
                                    <option value="3">Jane Doe</option> -->
                                </select>
                            </div>

                             <!-- Show when "Bike" is selected -->
                             <!-- <div x-show="formData.delivery_type === 'Bike'" class="isBike mt-4">
                                <label class="block text-gray-700 dark:text-gray-300">Assign Bike</label>
                                <select x-model="formData.bike_id" name="bike_id"
                                    class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" id="bike_driver">
                                    <option value="" selected disabled>Choose Bike</option>
                                    <option value="1">John Doe</option>
                                    <option value="2">Billy John</option>
                                    <option value="3">Jane Doe</option>
                                </select>
                            </div> -->
                        
                        </div>
                    </div>

                    <!-- Step 4: Backup Docs -->
                    <div x-show="step === 4" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300">Attach files</label>
                            <input type="file" multiple name="file_path[]" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="" id="file_path">
                        </div>
                    </div>


                    <!-- Navigation Buttons -->
                    <div class="flex flex-wrap gap-2 mt-6 mb-10">
                        <!-- Previous Button -->
                        <button
                            type="button"
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded dark:bg-gray-600 dark:text-white hover:bg-gray-300 hover:text-gray-700 dark:hover:bg-gray-600 dark:hover:text-white"
                            x-show="step > 1"
                            @click="prevStep">
                            Previous
                        </button>

                        <!-- Next Button (Shows on steps 1 and 2) -->
                        <button type="button" class="px-4 py-2 bg-blue-600 text-white rounded dark:bg-blue-500"
                            x-show="step < 4" @click="nextStep">
                            Next
                        </button>

                        <!-- Save & Continue Later Button -->
                        <button type="button" class="px-4 py-2 bg-yellow-500 text-white rounded dark:bg-yellow-400"
                            @click="saveProgress">
                            Save & Continue Later
                        </button>

                        <!-- Submit Button (Only shows on final step) -->
                        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded dark:bg-green-500"
                            x-show="step === 4">
                            Submit
                        </button>
                    </div>
                </form>
            </div>
            </div>

          </div>
        </main>
        <!-- ===== Main Content End ===== -->
      </div>
      <!-- ===== Content Area End ===== -->
    </div>
    <!-- ===== Page Wrapper End ===== -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script>
   $(document).ready(function() {
    $("#expected_departure_date, #expected_arrival_date").datepicker({
        dateFormat: "yy-mm-dd",
        changeMonth: true,
        changeYear: true,
        yearRange: "1900:2100",
        minDate: 0
    });
});

 populateCarrierSelect() 
function populateCarrierSelect() {
      $.ajax({
          url: requestURL + '/carriers/carriers',
          type: 'GET',
          headers: {
              'Authorization': 'Bearer ' + localStorage.getItem('auth_token'),
              'Accept': 'application/json'
          },
          success: (response) => {
              console.log('Carrier data:', response.carriers);
              if(response.carriers.length == 0){
                  //createToast('error', 'No customer found.');
                  return
              }
              if (Array.isArray(response.carriers)) {
                  var carrierselect = document.getElementById('carrier_id');

                  carrierselect.innerHTML = '';

                  var defaultOption = document.createElement('option');
                  defaultOption.value = '';
                  defaultOption.text = 'Carrier';
                  //defaultOption.disabled = true;
                  defaultOption.hidden = true;
                  carrierselect.appendChild(defaultOption);

                  
  
                  response.carriers.forEach(carrier => {
                      var option = document.createElement('option');
                      option.value = carrier.id;
                      option.text = carrier.name;
                      carrierselect.appendChild(option);


                  });
              } else {
                  console.error('Invalid response format:', response);
                  createToast('error', 'Invalid customer data received.');
              }
          },
          error: (xhr, status, error) => {
              console.error('API request failed:', xhr.responseText);
  
              if (xhr.status === 401) {
                  alert("Session expired. Please log in again.");
                  localStorage.removeItem('auth_token');
                  window.location.href = "/signin";
              } else {
                  try {
                      let response = JSON.parse(xhr.responseText);
                      let message = response.message || "An error occurred. Please try again.";
                      createToast('error', message);
                  } catch (e) {
                      createToast("error", "An unexpected error occurred.");
                  }
              }
          }
      });
  }

        function stepperForm() {
          return {
              step: localStorage.getItem('consolidate_shipment_step') ? parseInt(localStorage.getItem('consolidate_shipment_step')) : 1,
              formData: JSON.parse(localStorage.getItem('formData')) || {
                consolidation_type: '',
                    consolidated_for: '',
                    customer_email: '',
                    customer_phone: '',
                    receiver_name: '',
                    receiver_address: '',
                    receiver_phone: '',
                    receiver_email: '',
                    origin_warehouse: '',
                    destination_warehouse: '',
                    expected_departure_date: '',
                    expected_arrival_date: '',
                    total_weight: '',
                    total_shipping_cost: '',
                    handling_fee: '',
                    payment_status: '',
                    payment_method: '',
                    internal_notes: '',
                    driver_id: '',
                    carrier_id: '',
                    proof_of_delivery_path: '',
                    files: [],
                    charges: [{
                    charge_type: '',
                    comment: '',
                    units: '',
                    rate: '',
                    amount: '',
                    discount: '',
                    internal_notes_charges: ''
                    }],
                    
                    total_amount: '',
                    total_discount: '',
                    net_total: '',
              },
              nextStep() {
                  this.step++;
                  localStorage.setItem('consolidate_shipment_step', this.step);
              },
              prevStep() {
                  this.step--;
                  localStorage.setItem('consolidate_shipment_step', this.step);
              },
              async init() {
                    if (!this.formData.charges) {
                    this.formData.charges = [{
                    charge_type: '',
                    comment: '',
                    units: '',
                    rate: '',
                    amount: '',
                    discount: '',
                    internal_notes: ''
                    }];

                }
                   await this.fetchSettings();
            
                    // Set initial handling fee
                    this.formData.handling_fee = this.handlingFee;
                    
                    // Calculate initial totals
                    this.calculateTotals();
                    this.calculateTotalWeight();
                    
                    // Set up watchers
                    this.$watch('formData.charges', () => {
                        this.calculateTotals();
                    }, { deep: true });

                    this.$watch('formData.total_weight', () => {
                        this.calculateTotalWeight();
                    });

                    this.$watch('handlingFee', () => {
                        this.formData.handling_fee = this.handlingFee;
                        this.calculateTotalWeight();
                    });

                // Calculate initial totals
                // this.calculateTotals();
                // this.calculateTotalWeight();
                
                // // Watch for changes in charges
                // this.$watch('formData.charges', () => {
                //     if (this.formData.charges) { // Added null check
                //     this.calculateTotals();
                //     }
                // }, { deep: true });

                
                },
                  async fetchSettings() {
                    try {
                        const response = await fetch(requestURL + '/settings/data', {
                            headers: {
                                'Authorization': 'Bearer ' + localStorage.getItem('auth_token'),
                                'Accept': 'application/json'
                            }
                        });
                        
                        if (!response.ok) throw new Error('Network response was not ok');
                        
                        const datas = await response.json();
                        const data = Array.isArray(datas) ? datas[0] : datas;
                        
                        this.handlingFee = parseFloat(data.handling_fee) || 1;
                        this.formData.handling_fee = this.handlingFee;
                        
                    } catch (error) {
                        console.error('Error fetching settings:', error);
                        this.handlingFee = 1;
                        this.formData.handling_fee = this.handlingFee;
                    }
                },

                calculateTotalWeight() {
                    const weight = parseFloat(this.formData.total_weight) || 0;
                    this.formData.total_shipping_cost = (this.handlingFee * weight).toFixed(2);
                    //this.saveProgress();
                },

              saveProgress() {
                  localStorage.setItem('formData', JSON.stringify(this.formData));
                  localStorage.setItem('consolidate_shipment_step', this.step);
                //  alert("Progress saved successfully!");
                createToast('success', 'Progress saved successfully');
              },
              addCharge() {
                    this.formData.charges.push({
                        charge_type: '',
                        comment: '',
                        units: '',
                        rate: '',
                        amount: '',
                        discount: '',
                        internal_notes_charges: ''
                    });
                    //this.saveProgress();
                },
                
                removeCharge(index) {
                    if (this.formData.charges.length > 1) {
                        this.formData.charges.splice(index, 1);
                        this.calculateTotals();
                        //this.saveProgress();
                    }
                },
                
                calculateAmount(charge) {
                    const units = parseFloat(charge.units) || 0;
                    const rate = parseFloat(charge.rate) || 0;
                    charge.amount = (units * rate).toFixed(2);
                    this.calculateTotals();
                    //this.saveProgress();
                },
                
                calculateTotals() {
                    let total = 0;
                    let totalDiscount = 0;
                    
                    this.formData.charges.forEach(charge => {
                        const amount = parseFloat(charge.amount) || 0;
                        const discount = parseFloat(charge.discount) || 0;
                        
                        total += amount;
                        totalDiscount += discount;
                    });
                    
                    this.formData.total = total.toFixed(2);
                    this.formData.total_discount = totalDiscount.toFixed(2);
                    this.formData.net_total = (total - totalDiscount).toFixed(2);
                },
              saveAndSubmit() {
                  let form = document.getElementById("ConsolidateShipmentForm");
                    let formData = new FormData(form);
                    console.log("FormData Debugging:");
                    for (let pair of formData.entries()) {
                        console.log(pair[0] + ": " + pair[1]);
                    }
                   // return;
                    $.ajax({
                        url: requestURL+'/consolidate/create',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('auth_token'),
                            'Accept': 'application/json'
                        },

                        beforeSend:function(){
                            document.getElementById("Ajaxbackdrop").style.display = 'flex'
                        },

                        success: (response) => {
                            document.getElementById("Ajaxbackdrop").style.display = 'none'
                            //console.log('Form submitted successfully:', response);
                            createToast('success', response.message);
                            localStorage.removeItem('formData');
                            localStorage.removeItem('consolidate_shipment_step');
                            //alert("Form submitted successfully!");
                        },
                         error: (xhr, status, error) => {
                            document.getElementById("Ajaxbackdrop").style.display = 'none'
                            console.error('Form submission failed:', xhr.responseText);

                        try {
                            let response = JSON.parse(xhr.responseText);
                            
                            if (response.errors) {
                                let messages = Object.values(response.errors).flat().join('<br>'); // Combines multiple errors
                                createToast('error', messages);
                            } else if (response.message) {
                                createToast('error', response.message);
                            } else {
                                createToast('error', 'An unexpected error occurred. Please try again.');
                            }
                        } catch (e) {
                            createToast('error', 'An error occurred. Please check your input and try again.');
                        }
                    }
                });
              }
          }
      }


        populateDriverSelect();


      function handleLoadTypeChange(value) {
    if (value === 'import') {
        console.log(`Load type changed to ${value}`);
        // You can add specific logic for import/export here
        // For example, show/hide specific form sections
        document.getElementById('container').style.display = '';
        // Example: Show a message or change UI elements
        //alert(`Selected load type: ${value}`);
        
        // You could show/hide specific form sections
        // document.getElementById('importSection').style.display = value === 'import' ? 'block' : 'none';
        // document.getElementById('exportSection').style.display = value === 'export' ? 'block' : 'none';
    }
    
    // Trigger auto-save when selection changes
    //handleInputChange();
}
      </script>
      <script>
        function duplicateContainer() {
            var container = document.getElementById("container");
            var containerList = document.getElementById("containerList");
    
            // Clone container and remove display:none
            var newContainer = container.cloneNode(true);
            newContainer.style.display = "block";
    
            // Append new container
            containerList.appendChild(newContainer);
        }

        function removeContainer(element) {
            element.parentElement.parentElement.remove();
        }

        function duplicateBillto()
        {
            var billto = document.getElementById("billto");
            var billtoList = document.getElementById("billtoList");
            var newBillto = billto.cloneNode(true);
            billtoList.appendChild(newBillto);
        }

        function removeBillto(element)
        {
            element.parentElement.parentElement.remove();
        }
        //

        function duplicatePickup()
        {
            var pickup = document.getElementById("pickUPP");
            var pickupList = document.getElementById("pickupList");
            var newPickup = pickup.cloneNode(true);
            pickupList.appendChild(newPickup);
        }
        function removePickup(element)
        {
            element.parentElement.parentElement.remove();
        }

        
        function duplicateDropAt()
        {
            var pickup = document.getElementById("dropAt");
            var pickupList = document.getElementById("dropAtList");
            var newPickup = pickup.cloneNode(true);
            pickupList.appendChild(newPickup);
        }
        function removeDropAt(element)
        {
            element.parentElement.parentElement.remove();
        }

        function duplicateCharges()
        {
            var pickup = document.getElementById("chargesDuplicate");
            var pickupList = document.getElementById("chargesList");
            var newPickup = pickup.cloneNode(true);
            pickupList.appendChild(newPickup);
        }
        function removeCharges(element)
        {
            element.parentElement.parentElement.remove();
        }

        
    </script>
      
      <script src="./assets/js/newload.js"></script>
      <include src="./partials/footer.html"></include>
