<div x-data="metricGroup" class="grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 md:gap-6">
  <!-- Dynamic rendering of metric cards -->
  <template x-for="(item, index) in items" :key="index">
    <div :class="`rounded-2xl border border-gray-200 ${item.bgColor} p-5 dark:border-gray-800 dark:bg-white/[0.03] md:p-6`">
      <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-gray-100 dark:bg-gray-800">
        <!-- You can create a simple icon component or use condition-based rendering here -->
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M14.25 6.087c0-.355.186-.676.401-.959.221-.29.349-.634.349-1.003 0-1.036-1.007-1.875-2.25-1.875s-2.25.84-2.25 1.875c0 .369.128.713.349 1.003.215.283.401.604.401.959v0a.64.64 0 0 1-.657.643 48.39 48.39 0 0 1-4.163-.3c.186 1.613.293 3.25.315 4.907a.656.656 0 0 1-.658.663v0c-.355 0-.676-.186-.959-.401a1.647 1.647 0 0 0-1.003-.349c-1.036 0-1.875 1.007-1.875 2.25s.84 2.25 1.875 2.25c.369 0 .713-.128 1.003-.349.283-.215.604-.401.959-.401v0c.31 0 .555.26.532.57a48.039 48.039 0 0 1-.642 5.056c1.518.19 3.058.309 4.616.354a.64.64 0 0 0 .657-.643v0c0-.355-.186-.676-.401-.959a1.647 1.647 0 0 1-.349-1.003c0-1.035 1.008-1.875 2.25-1.875 1.243 0 2.25.84 2.25 1.875 0 .369-.128.713-.349 1.003-.215.283-.4.604-.4.959v0c0 .333.277.599.61.58a48.1 48.1 0 0 0 5.427-.63 48.05 48.05 0 0 0 .582-4.717.532.532 0 0 0-.533-.57v0c-.355 0-.676.186-.959.401-.29.221-.634.349-1.003.349-1.035 0-1.875-1.007-1.875-2.25s.84-2.25 1.875-2.25c.37 0 .713.128 1.003.349.283.215.604.401.96.401v0a.656.656 0 0 0 .658-.663 48.422 48.422 0 0 0-.37-5.36c-1.886.342-3.81.574-5.766.689a.578.578 0 0 1-.61-.58v0Z" />
        </svg>      
      </div>
      <div class="mt-5 flex items-end justify-between">
        <div>
          <span class="text-sm text-white dark:text-gray-400" x-text="item.title"></span>
          <h4 class="mt-2 text-title-sm font-medium text-white dark:text-white/90" x-text="item.value"></h4>
        </div>
        <!-- <span class="flex items-center gap-1 rounded-full bg-success-50 py-0.5 pl-2 pr-2.5 text-sm font-medium text-success-600 dark:bg-success-500/15 dark:text-success-500">
          <svg class="fill-current" width="12" height="12" viewBox="0 0 12 12" fill="none"
            xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" clip-rule="evenodd"
              d="M5.56462 1.62393C5.70193 1.47072 5.90135 1.37432 6.12329 1.37432C6.1236 1.37432 6.12391 1.37432 6.12422 1.37432C6.31631 1.37415 6.50845 1.44731 6.65505 1.59381L9.65514 4.5918C9.94814 4.88459 9.94831 5.35947 9.65552 5.65246C9.36273 5.94546 8.88785 5.94562 8.59486 5.65283L6.87329 3.93247L6.87329 10.125C6.87329 10.5392 6.53751 10.875 6.12329 10.875C5.70908 10.875 5.37329 10.5392 5.37329 10.125L5.37329 3.93578L3.65516 5.65282C3.36218 5.94562 2.8873 5.94547 2.5945 5.65248C2.3017 5.35949 2.30185 4.88462 2.59484 4.59182L5.56462 1.62393Z"
              fill="" />
          </svg>
          11.01%
        </span> -->
      </div>
    </div>
  </template>
</div>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('metricGroup', () => ({
            items: [],
            searchQuery: '',
            isLoading: false,
            userRole: '', // Add userRole to store the role
            
            init() {
                this.fetchUserRole(); // Get user role first
                this.fetchData();
            },

            fetchUserRole() {
                // Assuming you have a function to get user role
                this.userRole = localStorage.getItem('user_role') || '';
            },

            fetchData() {
                this.isLoading = true;
                fetch(requestGetURL + '/dashboard/dashboardstats', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('auth_token'),
                        'Accept': 'application/json'
                    }
                })
                .then(response => {
                    if (response.status === 401) {
                        throw new Error('Unauthorized');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('dashboard stats', data.data);
                    if (data.data) {
                        // Initialize empty array
                        this.items = [];
                        
                        // Only add superadministrator metrics if role matches businessadministrator
                        if (this.userRole === 'superadministrator') {
                            this.items.push(
                                {
                                    title: 'Total Income',
                                    value: data.data.totalincome || 0,
                                    icon: 'money',
                                    bgColor: 'bg-orange-600'
                                },
                                {
                                    title: 'Users',
                                    value: data.data.userCount || 0,
                                    icon: 'users',
                                    bgColor: 'bg-red-500'
                                },
                                {
                                    title: 'Plans',
                                    value: data.data.plans || 0,
                                    icon: 'puzzle',
                                    bgColor: 'bg-orange-200'
                                },
                                {
                                    title: 'Branches',
                                    value: data.data.branches || 0,
                                    icon: 'building',
                                    bgColor: 'bg-blue-500'
                                }
                            );
                        }
                        else if (this.userRole === 'businessadministrator') {
                            
                            this.items.push(
                                
                                {
                                    title: 'Total Users',
                                    value: data.data.userCount || 0,
                                    icon: 'users',
                                    bgColor: 'bg-red-500'
                                },
                                {
                                    title: 'Transactions',
                                    value: data.data.cardTransaction || 0,
                                    icon: 'puzzle',
                                    bgColor: 'bg-orange-200'
                                },
                                {
                                    title: 'Total Shipments',
                                    value: data.data.myShipments || 0,
                                    icon: 'puzzle',
                                    bgColor: 'bg-orange-200'
                                },
                                {
                                    title: 'Total Consolidated Shipments',
                                    value: data.data.myConsolidate || 0,
                                    icon: 'building',
                                    bgColor: 'bg-blue-500'
                                }
                            );
                        }
                        
                        else if (this.userRole === 'customer') {
                            
                            this.items.push(
                                
                                // {
                                //     title: 'Transactions',
                                //     value: data.data.cardTransaction || 0,
                                //     icon: 'puzzle',
                                //     bgColor: 'bg-orange-200'
                                // },
                                {
                                    title: 'Total Shipments',
                                    value: data.data.myShipments || 0,
                                    icon: 'puzzle',
                                    bgColor: 'bg-orange-200'
                                },
                                {
                                    title: 'Total Consolidated Shipments',
                                    value: data.data.myConsolidate || 0,
                                    icon: 'building',
                                    bgColor: 'bg-blue-500'
                                },
                                
                                {
                                    title: 'Total Consolidated Shipments',
                                    value: data.data.myConsolidate || 0,
                                    icon: 'building',
                                    bgColor: 'bg-blue-500'
                                }
                            );
                        }
                        
                        else if (this.userRole === 'driver') {
                            
                            this.items.push(
                                
                               
                                // {
                                //     title: 'Transactions',
                                //     value: data.data.cardTransaction || 0,
                                //     icon: 'puzzle',
                                //     bgColor: 'bg-orange-200'
                                // },
                                {
                                    title: 'Total Shipments',
                                    value: data.data.myShipments || 0,
                                    icon: 'puzzle',
                                    bgColor: 'bg-orange-200'
                                },
                                {
                                    title: 'Total Consolidated Shipments',
                                    value: data.data.myConsolidate || 0,
                                    icon: 'building',
                                    bgColor: 'bg-blue-500'
                                },
                                
                                {
                                    title: 'Total Revenue',
                                    value: data.data.grand_total_amount || 0,
                                    icon: 'building',
                                    bgColor: 'bg-blue-500'
                                }
                            );
                        }
                        
                        // Add common metrics for all roles here if needed
                        // this.items.push({...});
                        
                        console.log(this.items);
                    } else {
                        console.error('Invalid data format:', data);
                    }
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    if (error.message === 'Unauthorized') {
                        alert("Session expired. Please log in again.");
                        localStorage.removeItem('auth_token');
                        window.location.href = "/login";
                    }
                })
                .finally(() => {
                    this.isLoading = false;
                });
            }
        }));
    });

    // If you have a global fetchUserRole function
    if (typeof window.fetchUserRole === 'function') {
        window.fetchUserRole();
    }



    // document.addEventListener('alpine:init', () => {
    //       Alpine.data('metricGroup', () => ({
    //           items: [],
    //           searchQuery: '',
    //           isLoading: false,
          
    //           init() {
    //               this.fetchData();
    //           },

    //           fetchData() {
    //           this.isLoading = true;
    //           fetch(requestGetURL + '/dashboard/dashboardstats', {
    //               headers: {
    //                   'Authorization': 'Bearer ' + localStorage.getItem('auth_token'),
    //                   'Accept': 'application/json'
    //               }
    //           })
    //           .then(response => response.json())
    //           .then(data => {
    //               console.log('dashboard stats', data.data);
    //               if (data.data) {
    //                   // Access the specific properties directly instead of treating as array
    //                   this.items = [
    //                       {
    //                           title: 'Total Income',
    //                           value: data.data.totalincome,
    //                           icon: 'money',
    //                           bgColor: 'bg-orange-600'
    //                       },
    //                       {
    //                           title: 'Users',
    //                           value: data.data.userCount,
    //                           icon: 'users',
    //                           bgColor: 'bg-red-500'
    //                       },
    //                       {
    //                           title: 'Plans',
    //                           value: data.data.plans,
    //                           icon: 'puzzle',
    //                           bgColor: 'bg-orange-200'
    //                       },
    //                       {
    //                           title: 'Branches',
    //                           value: data.data.branches || 0, // Use default if not provided
    //                           icon: 'building',
    //                           bgColor: 'bg-blue-500'
    //                       }
    //                   ];
    //                   console.log(this.items);
    //               } else {
    //                   console.error('Invalid data format:', data);
    //               }
    //           })
    //           .catch(error => {
    //               console.error('Error fetching data:', error);
    //               if (error.status === 401) {
    //                   alert("Session expired. Please log in again.");
    //                   localStorage.removeItem('auth_token');
    //                   window.location.href = "/login";
    //               }
    //           })
    //           .finally(() => {
    //               this.isLoading = false;
    //           });
    //       }

    //       }));
    //   });

    //   if (typeof window.fetchUserRole === 'function') {
    //   window.fetchUserRole();
    // }
</script>
