<!doctype html>
<html lang="en">
  <head>
        <include src="./partials/mainhead.html"> </include>
        <script src="./assets/js/main.js"></script>
  </head>
  <body
    x-data="{ page: 'Settlement', 'loaded': true, 'darkMode': false, 'stickyMenu': false, 'sidebarToggle': false, 'scrollTop': false }"
    x-init="
         darkMode = JSON.parse(localStorage.getItem('darkMode'));
         $watch('darkMode', value => localStorage.setItem('darkMode', JSON.stringify(value)))"
    :class="{'dark bg-gray-900': darkMode === true}"
  >
    <!-- ===== Preloader Start ===== -->
    <include src="./partials/preloader.html"></include>
    <!-- ===== Preloader End ===== -->

    <!-- ===== Page Wrapper Start ===== -->
    <div class="flex h-screen overflow-hidden">
      <!-- ===== Sidebar Start ===== -->
      <include src="./partials/sidebar.html"></include>
      <!-- ===== Sidebar End ===== -->

      <!-- ===== Content Area Start ===== -->
      <div
        class="relative flex flex-1 flex-col overflow-y-auto overflow-x-hidden"
      >
        <!-- Small Device Overlay Start -->
        <include src="./partials/overlay.html" />
        <!-- Small Device Overlay End -->

        <!-- ===== Header Start ===== -->
        <include src="./partials/header.html" />
        <!-- ===== Header End ===== -->

        <!-- ===== Main Content Start ===== -->
        <main>
          <div class="mx-auto max-w-screen-2xl p-4 md:p-6">
            <!-- Breadcrumb Start -->
            <div x-data="{ pageName: `Settlement`}">
              <include src="./partials/breadcrumb.html" />
            </div>
            <!-- Breadcrumb End -->

            <div class="rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03]">
              <div x-data="stepperForm()" class="w-full mx-auto px-4 mt-5">
                <ol class="flex items-center justify-between w-full p-3 text-sm font-medium text-center text-gray-500 bg-white border border-gray-200 rounded-lg shadow-xs dark:text-gray-400 sm:text-base dark:bg-gray-800 dark:border-gray-700 sm:p-4 rtl:space-x-reverse">
                    <li class="flex-1 flex items-center justify-center" :class="{ 'text-blue-600 dark:text-blue-500': step === 1, 'text-gray-500 dark:text-gray-400': step !== 1 }">
                        <span class="flex items-center justify-center w-6 h-6 text-xs font-bold border rounded-full"
                            :class="{ 'border-blue-600 bg-blue-600 text-white dark:border-blue-500': step === 1, 'border-gray-500 dark:border-gray-400': step !== 1 }">
                            1
                        </span>
                        <span class="ml-2 hidden sm:inline">Basic Info</span>
                    </li>

                    <li class="flex-1 flex items-center justify-center" :class="{ 'text-blue-600 dark:text-blue-500': step === 2, 'text-gray-500 dark:text-gray-400': step !== 2 }">
                        <span class="flex items-center justify-center w-6 h-6 text-xs font-bold border rounded-full"
                            :class="{ 'border-blue-600 bg-blue-600 text-white dark:border-blue-500': step === 2, 'border-gray-500 dark:border-gray-400': step !== 2 }">
                            2
                        </span>
                        <span class="ml-2 hidden sm:inline">Payments</span>
                    </li>
                    
                    <li class="flex-1 flex items-center justify-center" :class="{ 'text-blue-600 dark:text-blue-500': step === 3, 'text-gray-500 dark:text-gray-400': step !== 3 }">
                        <span class="flex items-center justify-center w-6 h-6 text-xs font-bold border rounded-full"
                            :class="{ 'border-blue-600 bg-blue-600 text-white dark:border-blue-500': step === 3, 'border-gray-500 dark:border-gray-400': step !== 3 }">
                            3
                        </span>
                        <span class="ml-2 hidden sm:inline">Deductions</span>
                    </li>

                
                    <li class="flex-1 flex items-center justify-center" :class="{ 'text-blue-600 dark:text-blue-500': step === 4, 'text-gray-500 dark:text-gray-400': step !== 4 }">
                        <span class="flex items-center justify-center w-6 h-6 text-xs font-bold border rounded-full"
                            :class="{ 'border-blue-600 bg-blue-600 text-white dark:border-blue-500': step === 4, 'border-gray-500 dark:border-gray-400': step !== 4 }">
                            4
                        </span>
                        <span class="ml-2 hidden sm:inline">Backup Docs</span>
                    </li>
                </ol>
                
            
                <form class="mt-6 bg-white p-6 rounded-lg shadow dark:bg-gray-800 w-full border border-gray-200 dark:border-gray-700" @submit.prevent="saveAndSubmit" enctype="multipart/form-data" id="newSettlement">
                    <!-- Step 1: Basic Info -->
                    <div x-show="step === 1" >
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                        <!-- Your existing fields -->
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300">Office</label>
                            <select x-model="formData.office" name="office" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="" selected disabled>Select Office</option>
                                <option value="IN">IN</option>
                            </select>
                        </div>
                        <!-- <div>
                            <label class="block text-gray-700 dark:text-gray-300">Settlement #</label>
                            <input type="text" x-model="formData.settlement_no" name="settlement_no" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="will be auto generated if blank" />
                        </div> -->
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300">Settlement date</label>
                            <input type="text" x-model="formData.settlement_date" name="settlement_date" id="settlement_date" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="">
                        </div>
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300">Settlement Type</label>
                            <select x-model="formData.settlement_type" 
                                    @change="handleSettlementTypeChange()"
                                    name="settlement_type" 
                                    class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="" selected disabled>Select Type</option>
                                <option value="truck_settlement">Truck Settlement</option>
                                <option value="driver_settlement">Driver Settlement</option>
                                <option value="carrier_settlement">Carrier Settlement</option>
                                <option value="escrow_held_under_truck">Escrow (held under truck)</option>
                                <option value="escrow_held_under_driver">Escrow (held under driver)</option>
                                <option value="sales_commission">Sales Commission</option>
                                <option value="agency_commision">Agency Commission</option>
                            </select>
                        </div>
                        
                        <!-- Conditional fields -->
                        <div x-show="shouldShowDriverField()">
                            <label class="block text-gray-700 dark:text-gray-300">Driver</label>
                            <select x-model="formData.driver_id" id="driver_id" name="driver_id" 
                                class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" >
                                <option value="" selected disabled>Select</option>
                            
                            </select>
                        </div>
                        
                        <div x-show="shouldShowTruckField()">
                            <label class="block text-gray-700 dark:text-gray-300">Truck</label>
                            <select x-model="formData.truck_id" id="truck_id" name="truck_id" 
                                class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" >
                                </select>
                        </div>
                        
                        <div x-show="shouldShowCarrierField()">
                            <label class="block text-gray-700 dark:text-gray-300">Carrier</label>
                            <select x-model="formData.carrier_id" id="carrier_id" name="carrier_id" 
                                class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" >
                                </select>
                        </div>
                    </div>

                        <div id="" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                           
                           <div>
                                <label class="block text-gray-700 dark:text-gray-300">Weeks</label>
                                <select x-model="formData.settlement_week" name="settlement_week" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    <option value="" selected disabled>Select week</option>
                                    <template x-for="(week, index) in weeks" :key="index">
                                        <option 
                                            :value="week.value" 
                                            :selected="week.isCurrent" 
                                            :class="{ 'font-semibold bg-blue-100 dark:bg-blue-900': week.isCurrent }"
                                            x-text="week.label"
                                        ></option>
                                    </template>
                                </select>
                            </div>
                            <!-- <span class="block text-gray-700 dark:text-gray-300">OR</span> -->
                           <div>
                                <label class="block text-gray-700 dark:text-gray-300">From</label>
                                <input type="text" x-model="formData.week_from" name="week_from" id="week_from" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="">
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300">To</label>
                                <input type="text" x-model="formData.week_to" name="week_to" id="week_to" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="">
                            </div>

                        </div>
                        <div id="" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300">Payee (Payable to)</label>
                                <input type="text" x-model="formData.payee" name="payee" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="">
                            </div>
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300">Note to Payee</label>
                                <textarea x-model="formData.payee_note" cols="1" rows="1" name="payee_note" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            </textarea>
                            </div>
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300">Pay Via</label>
                                <select type="text" x-model="formData.payment_method" name="payment_method" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="">
                                    <option value="" selected disabled>Select Payment Method</option>
                                    <option value="check">Check</option>
                                    <option value="direct_deposit">Direct Deposit</option>
                                    <option value="credit_card">Credit Card</option>
                                    <option value="ach">ACH</option>
                                    <option value="cash">Cash</option>
                                    <option value="via_factoring">Via Factoring</option>
                                    <option value="wex">WEX Fleet One</option>
                                    <option value="zelle">Zelle</option>
                                    <option value="other">Other</option>
                                    <!-- <option value="wire">Wire</option> -->
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300">Check payment ref #</label>
                                <input type="text" x-model="formData.check_payment_reference" name="check_payment_reference" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="">
                            </div>
                        </div>

                        <div id="" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300">Payment Date</label>
                                <input type="text" x-model="formData.payment_date" name="payment_date" id="payment_date" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="">
                            </div>
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300">Payment Note</label>
                                <textarea type="text" x-model="formData.payment_note" name="payment_note" cols="1" rows="1"  class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" >
                                    </textarea>
                            </div> 
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300">Inter Notes</label>
                                <textarea type="text" x-model="formData.internal_notes" name="internal_notes" cols="1" rows="1" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="">
                                    </textarea>
                            </div>
                              <div>
                                <label class="block text-gray-700 dark:text-gray-300">Tags</label>
                                <input 
                                  type="text" 
                                  x-model="formData.tagsInput" 
                                  @keydown.space.prevent="addTag()"
                                  @keydown.enter.prevent="addTag()"
                                  @keydown.backspace="removeLastTag()"
                                  class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" 
                                  placeholder="Type tags separated by space"
                                  id="tags"
                                >
                                <!-- Display tags as chips -->
                                <div class="flex flex-wrap gap-2 mt-2">
                                  <template x-for="(tag, index) in formData.tags" :key="index">
                                    <div class="flex items-center bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded-full">
                                      <span x-text="tag" class="text-sm"></span>
                                      <button 
                                        @click="removeTag(index)" 
                                        class="ml-2 text-gray-500 hover:text-red-500"
                                        type="button"
                                      >
                                        &times;
                                      </button>
                                    </div>
                                  </template>
                                </div>
                              </div>
                        </div>

                        
                            <script>
                               $(document).ready(function () {
                                $("#week_from").datepicker({
                                    dateFormat: "yy-mm-dd"
                                });

                                $("#week_to").datepicker({
                                    dateFormat: "yy-mm-dd"
                                });

                                $("#payment_date").datepicker({
                                    dateFormat: "yy-mm-dd"
                                });

                                $("#settlement_date").datepicker({
                                    dateFormat: "yy-mm-dd"
                                });
                            });

                            </script>
                       
                    </div>

                    <!-- Step 2: Form w-9 -->
                    <div x-show="step === 2">
                        <div>
                            <h4 class="mb-1 text-sm font-medium text-gray-800 dark:text-white/90">Payments</h4>
                            <template x-for="(payment, index) in formData.payments" :key="index">
                                <div class="mb-6">
                                    <div class="flex justify-end mb-2">
                                        <span @click="addPayment()" 
                                              class="ml-2 cursor-pointer text-lg font-bold text-blue-600 dark:text-blue-400">
                                            +
                                        </span>
                                        <span @click="removePayment(index)" 
                                              class="ml-2 cursor-pointer text-lg font-bold text-blue-600 dark:text-red-500">
                                            x
                                        </span>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 paymentcalc">
                                        <div>
                                            <label class="block text-gray-700 dark:text-gray-300">Payment Type</label>
                                      <select x-model="payment.payment_type" name="payment_type[]" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                        <option value="" selected disabled>Select</option>
                                        <option value="trip_pay">Trip Pay</option>
                                        <option value="fuel_surcharge">Fuel Surcharge</option>
                                        <option value="trip_pay_local">Trip Pay (Local)</option>
                                        <option value="accesorial">Accesorial</option>
                                        <option value="additional_dray">Additional Dray</option>
                                        <option value="bobtail">Bobtail</option>
                                        <option value="cash_reimbursement">Cash Reimbursement</option>
                                        <option value="chasis_reposition">Chasis Reposition</option>
                                        <option value="chasis_split">Chasis Split</option>
                                        <option value="clean_inspection">Clean Inspection</option>
                                        <option value="detention">Detention</option>
                                        <option value="extra_miles">Extra Miles</option>
                                        <option value="funds_release">Funds Release</option>
                                        <option value="hauling_refrigerated_cargo">Hauling Refrigerated Cargo</option>
                                        <option value="harzadous_material">Harzadous Material</option>
                                        <option value="layover">Layover</option>
                                        <option value="lumber">Lumber</option>
                                        <option value="miscelleanous">Miscelleanous</option>
                                        <option value="out_of_route">Out of Route</option>
                                        <option value="over_weight">Over Weight</option>
                                        <option value="prepull">Pre Pull</option>
                                        <option value="redlivery">Redelivery</option>
                                        <option value="sign_on_bonus">Sign on Bonud</option>
                                        <option value="referral_bonus">Referral Bonus</option>
                                        <option value="scale">Scale</option>
                                        <option value="stop_off">Stop off</option>
                                        <option value="sweep_out">Sweep Out</option>
                                        <option value="toll">Toll</option>
                                        <option value="triaxle">Triaxle</option>
                                        <option value="waiting_time">Waiting Time</option>
                                        <option value=""></option>
                                      </select>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 dark:text-gray-300">Comment</label>
                                            <input type="text" x-model="payment.comment" name="comment[]" 
                                                   class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 dark:text-gray-300">Units</label>
                                            <input type="number" x-model="payment.units" 
                                                   @input="calculateAmount(payment)" name="units[]" 
                                                   class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 dark:text-gray-300">Rate</label>
                                            <input type="number" x-model="payment.rate" 
                                                   @input="calculateAmount(payment)" name="rate[]" 
                                                   class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                        </div>
                                    </div>
                    
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                        <div>
                                            <label class="block text-gray-700 dark:text-gray-300">Amount</label>
                                            <input type="number" x-model="payment.amount" name="amount[]" 
                                                   readonly class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 dark:text-gray-300">Internal Note</label>
                                            <input type="text" x-model="payment.payment_internal_notes" name="payment_internal_notes[]" 
                                                   class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                        </div>
                                    </div>
                                </div>
                            </template>
                    
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div>
                                    <label class="block text-gray-700 dark:text-gray-300">Total</label>
                                    <input type="number" x-model="formData.total" name="total" 
                                           readonly class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                </div>
                                <!-- <div>
                                    <label class="block text-gray-700 dark:text-gray-300">Total Discount</label>
                                    <input type="number" x-model="formData.total_discount" name="total_discount" 
                                           readonly class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                </div> -->
                                <div>
                                    <label class="block text-gray-700 dark:text-gray-300">Net Total</label>
                                    <input type="number" x-model="formData.net_total" name="net_total" 
                                           readonly class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                </div>
                            </div>
                        </div>



                        <div>
                            <hr class="mb-10">
                            <h4 class="mb-1 text-sm font-medium text-gray-800 dark:text-white/90">Escrow Release</h4>
                            <template x-for="(escrow, index) in formData.escrows" :key="index">
                                <div class="mb-6">
                                    <div class="flex justify-end mb-2">
                                        <span @click="addEscrowRelease()" 
                                              class="ml-2 cursor-pointer text-lg font-bold text-blue-600 dark:text-blue-400">
                                            +
                                        </span>
                                        <span @click="removeEscrowRelease(index)" 
                                              class="ml-2 cursor-pointer text-lg font-bold text-blue-600 dark:text-red-500">
                                            x
                                        </span>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 paymentcalc">
                                        <div>
                                            <label class="block text-gray-700 dark:text-gray-300">Account</label>
                                            <input type="text" x-model="escrow.escrow_release_account" name="escrow_release_account[]" 
                                                   class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 dark:text-gray-300">Realease this amount</label>
                                            <input type="number" x-model="escrow.escrow_release_amount" name="escrow_release_amount[]"
                                            @input="calculateTotalRelease()"
                                            class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 dark:text-gray-300">Comment</label>
                                            <textarea type="text" cols="1" rows="1" x-model="escrow.escrow_release_comment" name="escrow_release_comment[]" 
                                                   class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"> </textarea>
                                        </div>
                                    </div>
                                    </div>
                                </div>
                            </template>
                    
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div>
                                    <label class="block text-gray-700 dark:text-gray-300">Total</label>
                                    <input type="number" x-model="formData.totalRelease" name="totalRelease" 
                                           readonly class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                </div>
                            </div>
                        </div>

                        
                      </div>

                      <!-- Step 3: Deductions -->
                    <div x-show="step === 3">

                         <!-- <div>
                            <h4 class="mb-1 text-sm font-medium text-gray-800 dark:text-white/90">Payments</h4>
                            <template x-for="(payment, index) in formData.payments" :key="index">
                                <div class="mb-6">
                                    <div class="flex justify-end mb-2">
                                        <span @click="addPayment()" 
                                              class="ml-2 cursor-pointer text-lg font-bold text-blue-600 dark:text-blue-400">
                                            +
                                        </span>
                                        <span @click="removePayment(index)" 
                                              class="ml-2 cursor-pointer text-lg font-bold text-blue-600 dark:text-red-500">
                                            x
                                        </span>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 paymentcalc">
                                        <div>
                                            <label class="block text-gray-700 dark:text-gray-300">Payment Type</label>
                                      <select x-model="payment.payment_type" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                        <option value="" selected disabled>Select</option>
                                        <option value="trip_pay">Trip Pay</option>
                                        <option value="fuel_surcharge">Fuel Surcharge</option>
                                        <option value="trip_pay_local">Trip Pay (Local)</option>
                                        <option value="accesorial">Accesorial</option>
                                        <option value="additional_dray">Additional Dray</option>
                                        <option value="bobtail">Bobtail</option>
                                        <option value="cash_reimbursement">Cash Reimbursement</option>
                                        <option value="chasis_reposition">Chasis Reposition</option>
                                        <option value="chasis_split">Chasis Split</option>
                                        <option value="clean_inspection">Clean Inspection</option>
                                        <option value="detention">Detention</option>
                                        <option value="extra_miles">Extra Miles</option>
                                        <option value="funds_release">Funds Release</option>
                                        <option value="hauling_refrigerated_cargo">Hauling Refrigerated Cargo</option>
                                        <option value="harzadous_material">Harzadous Material</option>
                                        <option value="layover">Layover</option>
                                        <option value="lumber">Lumber</option>
                                        <option value="miscelleanous">Miscelleanous</option>
                                        <option value="out_of_route">Out of Route</option>
                                        <option value="over_weight">Over Weight</option>
                                        <option value="prepull">Pre Pull</option>
                                        <option value="redlivery">Redelivery</option>
                                        <option value="sign_on_bonus">Sign on Bonud</option>
                                        <option value="referral_bonus">Referral Bonus</option>
                                        <option value="scale">Scale</option>
                                        <option value="stop_off">Stop off</option>
                                        <option value="sweep_out">Sweep Out</option>
                                        <option value="toll">Toll</option>
                                        <option value="triaxle">Triaxle</option>
                                        <option value="waiting_time">Waiting Time</option>
                                        <option value=""></option>
                                      </select>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 dark:text-gray-300">Comment</label>
                                            <input type="text" x-model="payment.comment" name="comment[]" 
                                                   class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 dark:text-gray-300">Units</label>
                                            <input type="number" x-model="payment.units" 
                                                   @input="calculateAmount(payment)" name="units[]" 
                                                   class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 dark:text-gray-300">Rate</label>
                                            <input type="number" x-model="payment.rate" 
                                                   @input="calculateAmount(payment)" name="rate[]" 
                                                   class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                        </div>
                                    </div>
                    
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                        <div>
                                            <label class="block text-gray-700 dark:text-gray-300">Amount</label>
                                            <input type="number" x-model="payment.amount" name="amount[]" 
                                                   readonly class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 dark:text-gray-300">Internal Note</label>
                                            <input type="text" x-model="payment.payment_internal_notes" name="payment_internal_notes[]" 
                                                   class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                        </div>
                                    </div>
                                </div>
                            </template>
                    
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div>
                                    <label class="block text-gray-700 dark:text-gray-300">Total</label>
                                    <input type="number" x-model="formData.total" name="total" 
                                           readonly class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                </div>
                                <div>
                                    <label class="block text-gray-700 dark:text-gray-300">Total Discount</label>
                                    <input type="number" x-model="formData.total_discount" name="total_discount" 
                                           readonly class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                </div>
                                <div>
                                    <label class="block text-gray-700 dark:text-gray-300">Net Total</label>
                                    <input type="number" x-model="formData.net_total" name="net_total" 
                                           readonly class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                </div>
                            </div>
                        </div> -->



                        <div>
                            <!-- <hr class="mb-10"> -->
                            <h4 class="mb-1 text-sm font-medium text-gray-800 dark:text-white/90">Additional Deductions</h4>
                            <template x-for="(deduction, index) in formData.deductions" :key="index">
                                <div class="mb-6">
                                    <div class="flex justify-end mb-2">
                                        <span @click="addDeduction()" 
                                              class="ml-2 cursor-pointer text-lg font-bold text-blue-600 dark:text-blue-400">
                                            +
                                        </span>
                                        <span @click="removeDeduction(index)" 
                                              class="ml-2 cursor-pointer text-lg font-bold text-blue-600 dark:text-red-500">
                                            x
                                        </span>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 paymentcalc">
                                        <div>
                                            <label class="block text-gray-700 dark:text-gray-300">Deduction Type</label>
                                            <select type="text" x-model="deduction.deduction_type" name="deduction_type[]" 
                                                   class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                                   <option value="Escrow">Escrow</option>
                                                   <option value="Other">Other</option>
                                                   </select>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 dark:text-gray-300">Amount</label>
                                            <input type="number" x-model="deduction.deduction_amount" name="deduction_amount[]"
                                            @input="calculateTotalDeduction()"
                                            class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 dark:text-gray-300">Comment</label>
                                            <textarea type="text" cols="1" rows="1" x-model="deduction.deduction_comment" name="deduction_comment[]" 
                                                   class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"> </textarea>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-gray-700 dark:text-gray-300">Internal Notes</label>
                                            <textarea type="text" cols="1" rows="1" x-model="deduction.deduction_note" name="deduction_note[]" 
                                                   class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"> </textarea>
                                        </div>
                                    </div>
                                    </div>
                                </div>
                            </template>
                    
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div>
                                    <label class="block text-gray-700 dark:text-gray-300">Total</label>
                                    <input type="number" x-model="formData.totalDeduction" name="totalDeduction" 
                                           readonly class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                </div>
                            </div>
                        </div>
                   
                    </div>



                        <!-- Step 4 - Original Section -->
                        
                    <div x-show="step === 4" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div>
                          <label class="block text-gray-700 dark:text-gray-300">Attach files</label>
                          <input type="file" x-model="formData.file_path" multiple name="file_path[]" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Enter payment amount">
                      </div>
                    </div>
                    <!-- Navigation Buttons -->
                    <div class="flex justify-between mt-6">
                        <!-- Previous Button -->
                        <button type="button" class="px-4 py-2 bg-gray-300 text-gray-700 rounded dark:bg-gray-600 dark:text-white"
                            x-show="step > 1" @click="step = step - 1">
                            Previous
                        </button>

                        <!-- Next Button (Only shows when on step 1) -->
                        <button type="button" class="px-4 py-2 bg-blue-600 text-white rounded dark:bg-blue-500"
                            x-show="step < 4" @click="step = step + 1">
                            Next
                        </button>

                        <!-- Save & Continue Later Button -->
                        <button type="button" class="px-4 py-2 bg-yellow-500 text-white rounded dark:bg-yellow-400"
                            @click="saveProgress">
                            Save & Continue Later
                        </button>

                        <!-- Submit Button (Only shows on step 2) -->
                        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded dark:bg-green-500"
                            x-show="step === 4">
                            Submit
                        </button>
                    </div>

                </form>
            </div>
            </div>

          </div>
        </main>
        <!-- ===== Main Content End ===== -->
      </div>
      <!-- ===== Content Area End ===== -->
    </div>
    <!-- ===== Page Wrapper End ===== -->

    <script>
      function stepperForm() {
          return {
              step: localStorage.getItem('Settlement_step') ? parseInt(localStorage.getItem('Settlement_step')) : 1,
              formData: JSON.parse(localStorage.getItem('formData')) || {
                office: '',
                // settlement_no: '',
                settlement_date: '',
                driver_id: '',
                truck_id: '',
                carrier_id: '',
                settlement_type: '',
                week_from: '',
                week_to: '',
                payee: '',
                payee_note: '',
                payment_method: '',
                check_payment_reference: '',
                payment_date: '',
                payment_note: '',
                internal_notes: '',

                escrows: [],
                deductions: [],
                payments:[],
                totalDeduction: 0,
                totalEscrow: 0,
                totalAmount: 0,
                file_path: [],
                  tags: [],
                  tagsInput:'',
             
              },
               settlement_week: [],
                 handleSettlementTypeChange() {
                    this.formData.driver_id = '';
                    this.formData.truck_id = '';
                    this.formData.carrier_id = '';
                },
                
                
                shouldShowDriverField() {
                    return [
                        'driver_settlement', 
                        'escrow_held_under_driver'
                    ].includes(this.formData.settlement_type);
                },
                
                shouldShowTruckField() {
                    return [
                        'truck_settlement', 
                        'escrow_held_under_truck'
                    ].includes(this.formData.settlement_type);
                },
                
                shouldShowCarrierField() {
                    return this.formData.settlement_type === 'carrier_settlement';
                },
             addEscrowRelease() {
                this.formData.escrows.push({
                    escrow_release_account: '',
                    escrow_release_amount: '',
                    escrow_release_comment: '',
                    escrow_release_note: '',

                });
                 
             },
             removeEscrowRelease(index) {
                if (this.formData.escrows.length > 1) {
                    this.formData.escrows.splice(index, 1);
                }
             }, 
             
             addDeduction() {
                this.formData.deductions.push({
                    deduction_type: '',
                    deduction_amount: '',
                    deduction_comment: '',
                    deduction_note: '',
                });
             },
             removeDeduction(index) {
                if (this.formData.deductions.length > 1) {
                    this.formData.deductions.splice(index, 1);
                }
             },
    
                // Add a new provider
               // payment calculation methods
                addPayment() {
                    this.formData.payments.push({
                        payment_type: '',
                        comment: '',
                        units: '',
                        rate: '',
                        amount: '',
                        payment_internal_notes: ''
                    });
                    //this.saveProgress();
                },
                
                removePayment(index) {
                    if (this.formData.payments.length > 1) {
                        this.formData.payments.splice(index, 1);
                        this.calculateTotals();
                        //this.saveProgress();
                    }
                },
                
                calculateAmount(payment) {
                    const units = parseFloat(payment.units) || 0;
                    const rate = parseFloat(payment.rate) || 0;
                    payment.amount = (units * rate).toFixed(2);
                    this.calculateTotals();
                    //this.saveProgress();
                },
                
                calculateTotals() {
                    let total = 0;
                    let totalDiscount = 0;
                    
                    this.formData.payments.forEach(payment => {
                        const amount = parseFloat(payment.amount) || 0;
                        const discount = parseFloat(payment.discount) || 0;
                        
                        total += amount;
                        totalDiscount += discount;
                    });
                    
                    this.formData.total = total.toFixed(2);
                    //this.formData.total_discount = totalDiscount.toFixed(2);
                    this.formData.net_total = (total - totalDiscount).toFixed(2);
                },
               calculateTotalRelease() {
                    this.formData.totalRelease = this.formData.escrows.reduce((total, escrow) => {
                        const amount = parseFloat(escrow.escrow_release_amount) || 0;
                        return total + amount;
                    }, 0).toFixed(2); // Format to 2 decimal places like your payment totals
                },
                calculateTotalDeduction() {
                    this.formData.totalDeduction = this.formData.deductions.reduce((total, deduction) => {
                        const amount = parseFloat(deduction.deduction_amount) || 0;
                        return total + amount;
                    }, 0).toFixed(2); // Format to 2 decimal places like your payment totals
                },  
                init() {
                    //this.calculateTotalRelease();
                    this.generateWeeks();
                     // Initialize payments calculations
                    if (!this.formData.payments || this.formData.payments.length === 0) {
                        this.formData.payments = [{
                            payment_type: '',
                            comment: '',
                            units: '',
                            rate: '',
                            amount: '',
                        }];
                    }
                    if (!this.formData.escrow || this.formData.escrow.length === 0) {
                        this.formData.escrows = [{
                            escrow_release_account: '',
                            escrow_release_amount: '',
                            escrow_release_comment: '',
                            escrow_release_note: ''
                        }];
                    }

                    if (!this.formData.deduction || this.formData.deduction.length === 0) {
                        this.formData.deductions = [{
                            deduction_type: '',
                            deduction_amount: '',
                            deduction_comment: '',
                            deduction_note: ''
                        }];
                    }
                    this.calculateTotals();
                    this.$watch('formData.payments', () => this.calculateTotals(), { deep: true });
                    
                    this.calculateTotalDeduction();
                    this.calculateTotalRelease();
                    this.$watch('formData.escrows', () => this.calculateTotalRelease(), { deep: true });
                    this.$watch('formData.deductions', () => this.calculateTotalDeduction(), { deep: true });
                        },

                   generateWeeks() {
                    const weeks = [];
                    const now = new Date();
                    const currentWeekInfo = this.getWeekRange(now);
                    
                    // 1. First add 4 future weeks
                    for (let i = 1; i <= 4; i++) {
                        const futureDate = new Date(now);
                        futureDate.setDate(now.getDate() + (i * 7));
                        const weekInfo = this.getWeekRange(futureDate);
                        weeks.push({
                            label: `(WK-${weekInfo.weekNumber}) ${weekInfo.startDate} - ${weekInfo.endDate}`,
                            value: `${weekInfo.year}-${weekInfo.weekNumber}`,
                            isCurrent: false,
                            date: futureDate
                        });
                    }
                    
                    // 2. Add CURRENT WEEK (highlighted)
                    weeks.push({
                        label: `(WK-${currentWeekInfo.weekNumber}) ${currentWeekInfo.startDate} - ${currentWeekInfo.endDate} (Current Week)`,
                        value: `${currentWeekInfo.year}-${currentWeekInfo.weekNumber}`,
                        isCurrent: true,
                        date: now
                    });
                    
                    // 3. Add past weeks (from 2024 to current week)
                    const startYear = 2024;
                    let date = new Date(startYear, 0, 1);
                    
                    // Find first Sunday of 2024
                    while (date.getDay() !== 0) {
                        date.setDate(date.getDate() + 1);
                    }
                    
                    // Generate all weeks from 2024 to now
                    while (date < now) {
                        const weekInfo = this.getWeekRange(date);
                        weeks.push({
                            label: `(WK-${weekInfo.weekNumber}) ${weekInfo.startDate} - ${weekInfo.endDate}`,
                            value: `${weekInfo.year}-${weekInfo.weekNumber}`,
                            isCurrent: false,
                            date: new Date(date)
                        });
                        date.setDate(date.getDate() + 7);
                    }
                    
                    // Sort by date (newest first)
                    this.weeks = weeks.sort((a, b) => b.date - a.date);
                },
                
                getWeekRange(date) {
                    const d = new Date(date);
                    
                    // Find Sunday (start of week)
                    while (d.getDay() !== 0) {
                        d.setDate(d.getDate() - 1);
                    }
                    const startDate = new Date(d);
                    
                    // Find Saturday (end of week)
                    const endDate = new Date(d);
                    endDate.setDate(d.getDate() + 6);
                    
                    // Format dates as MM/DD/YYYY
                    const formatDate = (dateObj) => {
                        const month = dateObj.getMonth() + 1;
                        const day = dateObj.getDate();
                        const year = dateObj.getFullYear();
                        return `${month.toString().padStart(2, '0')}/${day.toString().padStart(2, '0')}/${year}`;
                    };
                    
                    // Get week number
                    const weekNumber = this.getWeekNumber(date);
                    
                    return {
                        startDate: formatDate(startDate),
                        endDate: formatDate(endDate),
                        weekNumber: weekNumber,
                        year: date.getFullYear()
                    };
                },
                
                getWeekNumber(date) {
                    const d = new Date(date);
                    d.setHours(0, 0, 0, 0);
                    d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
                    const week1 = new Date(d.getFullYear(), 0, 4);
                    return 1 + Math.round(((d - week1) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
                },
    

             
    
              nextStep() {
                  this.step++;
                  localStorage.setItem('Settlement_step', this.step);
              },
              prevStep() {
                  this.step--;
                  localStorage.setItem('Settlement_step', this.step);
              },
              saveProgress() {
                  localStorage.setItem('formData', JSON.stringify(this.formData));
                  localStorage.setItem('Settlement_step', this.step);
                  createToast('success', 'Progress saved successfully');
              },
              addTag() {
                if (this.formData.tagsInput.trim()) {
                    // Ensure tags array exists
                    this.formData.tags = this.formData.tags || [];
                    
                    // Split by spaces and filter out empty strings
                    const newTags = this.formData.tagsInput.split(' ')
                        .map(tag => tag.trim())
                        .filter(tag => tag.length > 0);
                    
                    // Add new tags to the array, avoiding duplicates
                    newTags.forEach(tag => {
                        if (!this.formData.tags.includes(tag)) {
                            this.formData.tags.push(tag);
                        }
                    });
                    
                    this.formData.tagsInput = '';
                }
            },
                
               removeTag(index) {
                    this.formData.tags = this.formData.tags || [];
                    this.formData.tags.splice(index, 1);
                },

                removeLastTag() {
                    this.formData.tags = this.formData.tags || [];
                    if (this.formData.tagsInput === '' && this.formData.tags.length > 0) {
                        this.formData.tags.pop();
                    }
                },
              saveAndSubmit() {
                    let form = document.getElementById("newSettlement");
                    let formData = new FormData(form);

                     const tags = this.formData.tags || []; // Fallback to empty array if undefined
                    if (tags.length > 0) {
                        formData.append('tags', tags.join(','));
                    }
                    for (let pair of formData.entries()) {
                        console.log(pair[0] + ": " + pair[1]);
                    }
                          console.log(localStorage.getItem('auth_token'))
                    //  return

                    $.ajax({
                        url: requestURL+'/settlements/settlements',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('auth_token'),
                            'Accept': 'application/json'
                        },

                        beforeSend:function(){
                            document.getElementById("Ajaxbackdrop").style.display = 'flex'
                        },

                        success: (response) => {
                            document.getElementById("Ajaxbackdrop").style.display = 'none'
                            //console.log('Form submitted successfully:', response);
                            createToast('success', response.message);
                            localStorage.removeItem('formData');
                            localStorage.removeItem('step');
                        },
                         error: (xhr, status, error) => {
                            document.getElementById("Ajaxbackdrop").style.display = 'none'
                            console.error('Form submission failed:', xhr.responseText);

                        try {
                            let response = JSON.parse(xhr.responseText);
                            
                            if (response.errors) {
                                let messages = Object.values(response.errors).flat().join('<br>'); // Combines multiple errors
                                createToast('error', messages);
                            } else if (response.message) {
                                createToast('error', response.message);
                            } else {
                                createToast('error',  response.error || 'An unexpected error occurred. Please try again.');
                            }
                        } catch (e) {
                            createToast('error', 'An error occurred. Please check your input and try again.');
                        }
                    }
                });
              }
          }
      }

    populateTruckSelect();
    populateCarrierSelect();
    populateDriverSelect();

     
        
    </script>
      
  </body>
</html>
