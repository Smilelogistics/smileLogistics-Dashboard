<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Bike delivery | </title>
    <include src="./partials/mainhead.html"> </include>
    <script src="./assets/js/main.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCkucOouQfm_4BEHGZbCphOp-xe4Mqvmv0&libraries&libraries=places"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Removed vanilla JS code as we're converting to AlpineJS
        });
    </script>
  </head>
  <body
    x-data="{ page: 'Delivery', 'loaded': true, 'darkMode': false, 'stickyMenu': false, 'sidebarToggle': false, 'scrollTop': false }"
    x-init="
         darkMode = JSON.parse(localStorage.getItem('darkMode'));
         $watch('darkMode', value => localStorage.setItem('darkMode', JSON.stringify(value)))"
    :class="{'dark bg-gray-900': darkMode === true}"
  >
    <!-- ===== Preloader Start ===== -->
    <include src="./partials/preloader.html"></include>
    <!-- ===== Preloader End ===== -->

    <!-- ===== Page Wrapper Start ===== -->
    <div class="flex h-screen overflow-hidden">
      <!-- ===== Sidebar Start ===== -->
      <include src="./partials/sidebar.html"></include>
      <!-- ===== Sidebar End ===== -->

      <!-- ===== Content Area Start ===== -->
      <div
        class="relative flex flex-1 flex-col overflow-y-auto overflow-x-hidden"
      >
        <!-- Small Device Overlay Start -->
        <include src="./partials/overlay.html" />
        <!-- Small Device Overlay End -->

        <!-- ===== Header Start ===== -->
        <include src="./partials/header.html" />
        <!-- ===== Header End ===== -->

        <!-- ===== Main Content Start ===== -->
        <main>
          <div class="mx-auto max-w-screen-2xl p-4 md:p-6">
            <!-- Breadcrumb Start -->
            <div x-data="{ pageName: `Delivery`}">
              <include src="./partials/breadcrumb.html" />
            </div>
            <!-- Breadcrumb End -->

            <!-- Modal -->
            <div id="modal" class="modal">
                <div class="modal-content">
                <span id="closeModal" class="close">&times;</span>
                <h2>Sign and Save, then upload the signed signature</h2>
                <div id="signature-pad" class="signature-pad">
                    <canvas id="signature_pad" width="400" height="200"></canvas>
                    <div class="buttons">
                        <button type="button" id="clear" class="focus:outline-none text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-900">Reset</button>

                        <button type="button" id="save" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800">Save</button>
                    </div>
                </div>
                </div>
            </div>

            <div class="rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03]">
              <div x-data="deliveryApp()" class="w-full mt-10 mb-10 mx-auto px-4">
                <ol class="flex items-center justify-between w-full p-3 text-sm font-medium text-center text-gray-500 bg-white border border-gray-200 rounded-lg shadow-xs dark:text-gray-400 sm:text-base dark:bg-gray-800 dark:border-gray-700 sm:p-4 rtl:space-x-reverse">
                    <li class="flex-1 flex items-center justify-center" :class="{ 'text-blue-600 dark:text-blue-500': step === 1, 'text-gray-500 dark:text-gray-400': step !== 1 }">
                        <span class="flex items-center justify-center w-6 h-6 text-xs font-bold border rounded-full"
                            :class="{ 'border-blue-600 bg-blue-600 text-white dark:border-blue-500': step === 1, 'border-gray-500 dark:border-gray-400': step !== 1 }">
                            1
                        </span>
                        <span class="ml-2 hidden sm:inline">Smiles Delivery</span>
                    </li>
                </ol>
                
                <div id="map" class="w-full h-[400px] rounded-lg shadow-lg flex items-center justify-center text-gray-500">
                  Getting driver location...
                </div>

               
            </div>
            </div>
          </div>
        </main>
        <!-- ===== Main Content End ===== -->
      </div>
      <!-- ===== Content Area End ===== -->
    </div>
    <!-- ===== Page Wrapper End ===== -->
    <script>
//       driverIcon: {
//   url: './assets/img/bike-icon.png',
//   scaledSize: new google.maps.Size(50, 50),
// },

function deliveryApp() {
    return {
        step: 1,
        map: null,
        marker: null,
        id: null,
        latitude: null,
        longitude: null,
        lastPosition: null,
        driverIcon: {
            path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
            scale: 5,
            strokeColor: "#1E90FF",
            strokeWeight: 3,
        },

        async init() {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedId = urlParams.get('id');

            if (!encodedId) {
                console.error('❌ No ID found in the URL');
                return;
            }

            this.id = atob(encodedId);

            // Fetch location first
            await this.fetchLocation();

            if (this.latitude && this.longitude) {
                this.initMap();
            } else {
                console.error("❌ No coordinates yet to initialize map.");
            }

            // Continue fetching every 10 seconds
            setInterval(() => this.fetchLocation(), 10000);
        },

        async fetchLocation() {
            try {
                const url = `${requestURL}/drivers/location/${this.id}`;
                console.log(`Fetching location for driver: ${url}`);

                const res = await fetch(url, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('auth_token'),
                        'Accept': 'application/json'
                    }
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const data = await res.json();
                console.log('Location data received:', data);

                const lat = parseFloat(data.driver.latitude);
                const lng = parseFloat(data.driver.longitude);

                if (isNaN(lat) || isNaN(lng)) throw new Error("Invalid coordinates");

                this.lastPosition = { lat: this.latitude, lng: this.longitude };
                this.latitude = lat;
                this.longitude = lng;

                console.log(`Coordinates set: ${this.latitude}, ${this.longitude}`);

                // Update marker if map is ready
                if (this.map && this.marker) {
                    this.animateMarker(this.marker, this.lastPosition, { lat, lng });
                    this.map.panTo({ lat, lng });
                    console.log('Map updated with new coordinates');
                }

            } catch (error) {
                console.error('Location fetch failed:', error);
            }
        },

        initMap() {
            console.log("Initializing map at:", this.latitude, this.longitude);

            this.map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: this.latitude, lng: this.longitude },
                zoom: 15,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });

            this.marker = new google.maps.Marker({
                position: { lat: this.latitude, lng: this.longitude },
                map: this.map,
                title: "Driver's current location",
                icon: this.driverIcon,
            });
        },

        // Smooth marker animation between old and new positions
        animateMarker(marker, from, to, duration = 1000) {
            if (!from || !to) {
                marker.setPosition(to);
                return;
            }

            const deltaLat = (to.lat - from.lat) / 60;
            const deltaLng = (to.lng - from.lng) / 60;
            let i = 0;

            const move = () => {
                i++;
                const lat = from.lat + deltaLat * i;
                const lng = from.lng + deltaLng * i;
                marker.setPosition({ lat, lng });

                // Optional: rotate icon toward new direction
                const angle = this.calculateBearing(from, to);
                marker.setIcon({
                    ...this.driverIcon,
                    rotation: angle
                });

                if (i < 60) requestAnimationFrame(move);
            };
            requestAnimationFrame(move);
        },

        // Bearing calculation for rotation
        calculateBearing(from, to) {
            const lat1 = (from.lat * Math.PI) / 180;
            const lat2 = (to.lat * Math.PI) / 180;
            const dLng = ((to.lng - from.lng) * Math.PI) / 180;

            const y = Math.sin(dLng) * Math.cos(lat2);
            const x =
                Math.cos(lat1) * Math.sin(lat2) -
                Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLng);
            const bearing = (Math.atan2(y, x) * 180) / Math.PI;

            return (bearing + 360) % 360; // normalize 0–360
        },
    };
}

</script>


    <script>
if (navigator.geolocation) {
  navigator.geolocation.watchPosition(
    function (position) {
      console.log("Driver position updated:", position);

      fetch(`${requestURL}/drivers/location/update`, {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + localStorage.getItem("auth_token"),
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify({
          latitude: position.coords.latitude,
          longitude: position.coords.longitude
        })
      })
      .then(response => {
        if (!response.ok) {
          return response.text().then(err => {
            console.error("Update failed:", err);
          });
        }
        return response.json();
      })
      .then(data => {
        console.log("Location updated on server:", data);
      })
      .catch(error => {
        console.error("Error updating location:", error);
      });
    },
    function (error) {
      console.error("Error getting position:", error.message);
    },
    {
      enableHighAccuracy: true,
      maximumAge: 10000,
      timeout: 10000
    }
  );
} else {
  console.error("Geolocation is not supported by this browser.");
}


    </script>
      
    <script src="./assets/js/newload.js"></script>
    <include src="./partials/footer.html"></include>
  </body>
</html>