<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">

    <include src="./partials/mainhead.html"> </include>
    <script src="./assets/js/main.js"></script>
    <title>Consolidate | </title>
  </head>
  <body
    x-data="{ page: 'view_consolidated_single', 'loaded': true, 'darkMode': false, 'stickyMenu': false, 'sidebarToggle': false, 'scrollTop': false }"
    x-init="
         darkMode = JSON.parse(localStorage.getItem('darkMode'));
         $watch('darkMode', value => localStorage.setItem('darkMode', JSON.stringify(value)))"
    :class="{'dark bg-gray-900': darkMode === true}"
  >
    <!-- ===== Preloader tart ===== -->
    <include src="./partials/preloader.html"></include>
    <!-- ===== Preloader End ===== -->

    <!-- ===== Page Wrapper Start ===== -->
    <div class="flex h-screen overflow-hidden">
      <!-- ===== Sidebar Start ===== -->
      <include src="./partials/sidebar.html"></include>
      <!-- ===== Sidebar End ===== -->

      <!-- ===== Content Area Start ===== -->
      <div
        class="relative flex flex-1 flex-col overflow-y-auto overflow-x-hidden"
      >
        <!-- Small Device Overlay Start -->
        <include src="./partials/overlay.html" />
        <!-- Small Device Overlay End -->

        <!-- ===== Header Start ===== -->
        <include src="./partials/header.html" />
        <!-- ===== Header End ===== -->

        <!-- ===== Main Content Start ===== -->
        <main>
          <div class="mx-auto max-w-screen-2xl p-4 md:p-6">
            <!-- Breadcrumb Start -->
            <div x-data="{ pageName: `View Consolidate`}">
              <include src="./partials/breadcrumb.html" />
            </div>
            <!-- Breadcrumb End -->
             
            <div class="w-full">
              <div class="space-y-12">
                <div class="rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03] p-2">
                  <div class="px-5 py-4 sm:px-6 sm:py-5">
                    <h3 class="text-base font-medium text-gray-800 dark:text-white/90">
                      Consolidate Details
                    </h3>
                  </div>
          
                  <!-- Inputs Container -->
                  <div class="border-t border-gray-100 p-5 dark:border-gray-800 sm:p-6">
                    <div class="overflow-hidden rounded-xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03]"
                    >
                      <div class="max-w-full overflow-x-auto">
                        <div class="max-w-6xl mx-auto" x-data="singleItem">
                          <!-- Loading State -->
                          <template x-if="isLoading">
                            <div class="text-center py-8">
                              <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
                              <p class="mt-2 text-gray-600">Loading details...</p>
                            </div>
                          </template>
                        
                          <!-- Main Card -->
                          <div id="printableArea" class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden border border-gray-200 dark:border-gray-700" x-show="!isLoading">
                            <!-- Header -->
                            <div class="bg-gray-50 dark:bg-gray-700 px-6 py-4 border-b border-gray-200 dark:border-gray-600 flex justify-between items-center">
                              <div>
                                <h2 class="text-xl font-semibold text-gray-800 dark:text-white">Consolidate Details</h2>
                                <p class="text-sm text-gray-500 dark:text-gray-300" x-text="'Reference #: ' + (formData.id || 'N/A')"></p>
                              </div>
                              <!-- <span class="px-3 py-1 text-xs font-semibold rounded-full dark:text-white" 
                                    :class="{
                                      'bg-green-100 text-green-800': formData.shipment_type === 'delivered',
                                      'bg-blue-100 text-blue-800': formData.shipment_type === 'in_transit',
                                      'bg-yellow-100 text-yellow-800': formData.shipment_type === 'pending'
                                    }"
                                    x-text="formData.shipment_type ? formData.shipment_type.replace('_', ' ').toUpperCase() : 'STATUS UNKNOWN'">
                              </span> -->
                            </div>
                            
                            <!-- Content Grid -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 p-6">
                              <!-- Basic Information -->
                               <!-- Row1 -->
                               <div class="md:col-span-2 lg:col-span-3 font-sans border border-gray-300 dark:border-gray-600 p-4 rounded-lg">
                                <h1 class="text-center border-b-2 border-gray-300 dark:border-gray-600 pb-3 mb-4 text-lg font-bold text-gray-800 dark:text-gray-100">
                                  CONSOLIDATED SHIPMENT DETAILS
                                </h1>

                                <!-- Basic Information Section -->
                                <table class="w-full border-collapse mb-6">
                                  <tr>
                                    <td colspan="3" class="border border-gray-300 dark:border-gray-600 p-3 bg-gray-100 dark:bg-gray-800">
                                      <strong class="text-sm text-gray-700 dark:text-gray-300">BASIC INFORMATION</strong>
                                    </td>
                                  </tr>
                                  <tr>
                                    <td class="border border-gray-300 dark:border-gray-600 p-3 w-1/3">
                                      <p class="text-xs text-gray-500 dark:text-gray-400">Consolidate For</p>
                                      <p class="text-sm font-medium text-gray-900 dark:text-gray-100" x-text="formData.consolidate_for || 'N/A'"></p>
                                    </td>
                                    <td class="border border-gray-300 dark:border-gray-600 p-3 w-1/3">
                                      <p class="text-xs text-gray-500 dark:text-gray-400">Consolidate Type</p>
                                      <p class="text-sm font-medium text-gray-900 dark:text-gray-100" x-text="formData.consolidate_type || 'N/A'"></p>
                                    </td>
                                    <td class="border border-gray-300 dark:border-gray-600 p-3 w-1/3">
                                      <p class="text-xs text-gray-500 dark:text-gray-400">Customer Name</p>
                                      <p class="text-sm font-medium text-gray-900 dark:text-gray-100" x-text="formData.customer_name || 'N/A'"></p>
                                    </td>
                                  </tr>
                                  <tr>
                                    <td class="border border-gray-300 dark:border-gray-600 p-3">
                                      <p class="text-xs text-gray-500 dark:text-gray-400">Customer Email</p>
                                      <p class="text-sm font-medium text-gray-900 dark:text-gray-100" x-text="formData.customer_email || 'N/A'"></p>
                                    </td>
                                    <td class="border border-gray-300 dark:border-gray-600 p-3">
                                      <p class="text-xs text-gray-500 dark:text-gray-400">Customer Phone</p>
                                      <p class="text-sm font-medium text-gray-900 dark:text-gray-100" x-text="formData.customer_phone || 'N/A'"></p>
                                    </td>
                                    <td class="border border-gray-300 dark:border-gray-600 p-3">
                                      <p class="text-xs text-gray-500 dark:text-gray-400">Receiver Email</p>
                                      <p class="text-sm font-medium text-gray-900 dark:text-gray-100" x-text="formData.receiver_email || 'N/A'"></p>
                                    </td>
                                  </tr>
                                  <tr>
                                    <td class="border border-gray-300 dark:border-gray-600 p-3">
                                      <p class="text-xs text-gray-500 dark:text-gray-400">Receiver Phone</p>
                                      <p class="text-sm font-medium text-gray-900 dark:text-gray-100" x-text="formData.receiver_phone || 'N/A'"></p>
                                    </td>
                                    <td class="border border-gray-300 dark:border-gray-600 p-3">
                                      <p class="text-xs text-gray-500 dark:text-gray-400">Receiver Address</p>
                                      <p class="text-sm font-medium text-gray-900 dark:text-gray-100" x-text="formData.receiver_address || 'N/A'"></p>
                                    </td>
                                    <td class="border border-gray-300 dark:border-gray-600 p-3">
                                      <p class="text-xs text-gray-500 dark:text-gray-400">Origin Warehouse</p>
                                      <p class="text-sm font-medium text-gray-900 dark:text-gray-100" x-text="formData.origin_warehouse || 'N/A'"></p>
                                    </td>
                                  </tr>
                                  <tr>
                                    <td class="border border-gray-300 dark:border-gray-600 p-3">
                                      <p class="text-xs text-gray-500 dark:text-gray-400">Destination Warehouse</p>
                                      <p class="text-sm font-medium text-gray-900 dark:text-gray-100" x-text="formData.destination_warehouse || 'N/A'"></p>
                                    </td>
                                    <td class="border border-gray-300 dark:border-gray-600 p-3">
                                      <p class="text-xs text-gray-500 dark:text-gray-400">Departure Date</p>
                                      <p class="text-sm font-medium text-gray-900 dark:text-gray-100" x-text="formData.expected_departure_date || 'N/A'"></p>
                                    </td>
                                    <td class="border border-gray-300 dark:border-gray-600 p-3">
                                      <p class="text-xs text-gray-500 dark:text-gray-400">Arrival Date</p>
                                      <p class="text-sm font-medium text-gray-900 dark:text-gray-100" x-text="formData.expected_arrival_date || 'N/A'"></p>
                                    </td>
                                  </tr>
                                  <tr>
                                    <td class="border border-gray-300 dark:border-gray-600 p-3">
                                      <p class="text-xs text-gray-500 dark:text-gray-400">Total Weight</p>
                                      <p class="text-sm font-medium text-gray-900 dark:text-gray-100" x-text="formData.total_weight || 'N/A'"></p>
                                    </td>
                                    <td class="border border-gray-300 dark:border-gray-600 p-3">
                                      <p class="text-xs text-gray-500 dark:text-gray-400">Total Cost</p>
                                      <p class="text-sm font-medium text-gray-900 dark:text-gray-100" x-text="formData.total_shipping_cost || 'N/A'"></p>
                                    </td>
                                    <td class="border border-gray-300 dark:border-gray-600 p-3">
                                      <p class="text-xs text-gray-500 dark:text-gray-400">Handling Fee</p>
                                      <p class="text-sm font-medium text-gray-900 dark:text-gray-100" x-text="formData.handling_fee || 'N/A'"></p>
                                    </td>
                                  </tr>
                                  <tr>
                                    <td class="border border-gray-300 dark:border-gray-600 p-3">
                                      <p class="text-xs text-gray-500 dark:text-gray-400">Payment Method</p>
                                      <p class="text-sm font-medium text-gray-900 dark:text-gray-100" x-text="formData.payment_method || 'N/A'"></p>
                                    </td>
                                    <td class="border border-gray-300 dark:border-gray-600 p-3">
                                      <p class="text-xs text-gray-500 dark:text-gray-400">Payment Status</p>
                                      <p class="text-sm font-medium text-gray-900 dark:text-gray-100" x-text="formData.payment_status || 'N/A'"></p>
                                    </td>
                                    <td class="border border-gray-300 dark:border-gray-600 p-3">
                                      <p class="text-xs text-gray-500 dark:text-gray-400">Internal Notes</p>
                                      <p class="text-sm font-medium text-gray-900 dark:text-gray-100" x-text="formData.internal_notes || 'N/A'"></p>
                                    </td>
                                  </tr>
                                </table>
                              </div>

                            <!-- Backup Docs -->
                            <div class="space-y-4">
                              <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 border-b pb-2">Backup Docs</h3>

                              <template x-if="Array.isArray(formData.documents) && formData.documents.length > 0">
                                <div class="grid grid-cols-2 gap-4">
                                  <template x-for="doc in formData.documents" :key="doc.id">
                                    <div>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">Document</p>
                                
                                        <!-- If image -->
                                        <template x-if="doc.file_path && doc.file_path.match(/\.(jpeg|jpg|png|gif)$/i)">
                                            <img :src="doc.file_path" class="w-32 h-32 object-cover rounded-md" alt="Document Image" />
                                            <a :href="doc.file_path" target="_blank" class="text-sm font-medium text-gray-500 dark:text-gray-400 border-b pb-2 hover:text-gray-600 dark:hover:text-gray-300">
                                              View Document
                                          </a>
                                        </template>
                                
                                        <!-- If document -->
                                        <template x-if="doc.file_path && doc.file_path.match(/\.(pdf|docx?|xlsx?)$/i)">
                                            <a :href="doc.file_path" target="_blank" class="text-sm font-medium text-gray-500 dark:text-gray-400 border-b pb-2 hover:text-gray-600 dark:hover:text-gray-300">
                                                View Document
                                            </a>
                                        </template>
                                    </div>
                                  </template>
                                
                                </div>
                            </template>
                            <!-- If image -->
                           <!-- <div>
                            <template x-if="proof_of_delivery_path && proof_of_delivery_path.match(/\.(jpeg|jpg|png|gif)$/i)">
                              <p class="text-xs text-gray-500 dark:text-gray-400">Proof of Delivery</p>
                              <img :src="proof_of_delivery_path" class="w-32 h-32 object-cover rounded-md" alt="Document Image" />
                          </template>
                           </div> -->
                                </div>
                            </template>
                            
                                      <!-- Check for proof_of_delivery_path -->
                                      

                            <template x-if="formData.proof_of_delivery_path && formData.proof_of_delivery_path !== ''">
                              <div class="mt-3">
                                  <img :src="formData.proof_of_delivery_path" class="w-32 h-32 object-cover rounded-md" alt="Proof of Delivery" />
                                  <p class="text-sm text-gray-600 mt-1">Signature</p>
                              </div>
                          </template>
                          
                            

                              <template x-if="!Array.isArray(formData.documents) || formData.documents.length === 0">
                                  <p class="text-xs text-gray-500 dark:text-gray-400">No documents available.</p>
                              </template>
                            </div>

                            
                             
                              </div>

                              
                            </div>
                            
                            <!-- Footer -->
                            <div class="bg-gray-50 dark:bg-gray-700 px-6 py-3 border-t border-gray-200 dark:border-gray-600 flex justify-between">
                              <div class="text-sm text-gray-500 dark:text-gray-400" x-text="'Last updated: ' + (new Date().toLocaleString())"></div>
                              <div>
                                <!-- <button class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition mr-2">
                                  Edit Shipment
                                </button> -->
                                
                                <button @click="downloadAsPDF()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition mr-2 no-print">
                                  Download PDF
                                </button>
                                <button onclick="printDiv('printableArea')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition">
                                  Print
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                    </div>

                  </div>
                </div>
              </div>
            </div>

        
          </div>
        </main>
        <!-- ===== Main Content End ===== -->
      </div>
      <!-- ===== Content Area End ===== -->
    </div>
    <!-- ===== Page Wrapper End ===== -->

    <!-- <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script> -->
    <script>
      

      document.addEventListener('alpine:init', () => {
        Alpine.data('singleItem', () => ({
          id: null,
          formData: '',
          isLoading: false,
          
          init() {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedId = urlParams.get('id');
            if (encodedId) {
              this.id = atob(encodedId);
              this.fetchData();
            } else {
              console.error('No ID found in the URL');
            }
          },
          downloadAsPDF() {
  // Store button state at the start (in case of early errors)
  let button = null;
  let originalButtonText = '';
  
  if (event && event.target) {
    button = event.target;
    originalButtonText = button.innerHTML;
    button.innerHTML = 'Generating PDF...';
    button.disabled = true;
  }

  try {
    const element = document.getElementById('printableArea');
    if (!element) {
      throw new Error('Printable area not found');
    }

    // Clone the element to avoid modifying the original
    const clonedElement = element.cloneNode(true);
    
    // Remove elements with no-print class
    const noPrintElements = clonedElement.querySelectorAll('.no-print');
    noPrintElements.forEach(el => el.remove());
    
    // Add title to the PDF
    const title = document.createElement('h1');
    const referenceText = document.querySelector('[x-text="\'Reference #: \' + (formData.id || \'N/A\')"]')?.textContent || '';
    title.textContent = `Load ${referenceText.replace('Reference #: ', '')}`;
    title.style.textAlign = 'center';
    title.style.marginBottom = '20px';
    title.style.fontSize = '24px';
    clonedElement.insertBefore(title, clonedElement.firstChild);

    // PDF options
    const opt = {
      margin: 10,
      filename: `Load_${referenceText.replace('Reference #: ', '') || new Date().toISOString().split('T')[0]}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { 
        scale: 2,
        logging: true,
        useCORS: true,
        letterRendering: true,
        allowTaint: true
      },
      jsPDF: { 
        unit: 'mm', 
        format: 'a4', 
        orientation: 'portrait',
        hotfixes: ["px_scaling"] 
      }
    };

    // Return the promise so callers can await it if needed
    return html2pdf()
      .set(opt)
      .from(clonedElement)
      .save()
      .then(() => {
        console.log('PDF generated successfully');
      })
      .catch((pdfError) => {
        console.error('PDF generation failed:', pdfError);
        throw new Error('Failed to generate PDF');
      });
    
  } catch (error) {
    console.error('PDF generation failed:', error);
    alert('Failed to generate PDF. Please try again.');
    throw error; // Re-throw to allow error handling by caller
  } finally {
    // Restore button state if we modified it
    if (button) {
      button.innerHTML = originalButtonText;
      button.disabled = false;
    }
  }
},

          fetchData() {
            this.isLoading = true;
            fetch(`${requestURL}/consolidate/shipment/${this.id}`, {
              headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('auth_token'),
                'Accept': 'application/json'
              }
            })
            .then(response => {
              if (!response.ok) {
                throw new Error('Network response was not ok');
              }
              return response.json();
            })
            .then(data => {
              console.log('Single consolidated data:', data.consolidateShipment);
              this.formData = {
                // Basic Information
                id: data.consolidateShipment.id || '',
                consolidation_type: data.consolidateShipment.consolidation_type || '',
                consolidate_for: data.consolidateShipment.consolidate_for || '',
                customer_email: data.consolidateShipment.customer_email || '',
                customer_phone: data.consolidateShipment.customer_phone || '',
                receiver_name: data.consolidateShipment.receiver_name || '',
                receiver_address: data.consolidateShipment.receiver_address || '',
                receiver_phone: data.consolidateShipment.receiver_phone || '',
                receiver_email: data.consolidateShipment.receiver_email || '',
                origin_warehouse: data.consolidateShipment.origin_warehouse || '',
                destination_warehouse: data.consolidateShipment.destination_warehouse || '',
                expected_arrival_date: data.consolidateShipment.expected_arrival_date || '',
                expected_depature_date: data.consolidateShipment.expected_depature_date || '',
                total_weight: data.consolidateShipment.total_weight || '',
                total_shipment_cost: data.consolidateShipment.total_shipment_cost || '',
                handling_fee: data.consolidateShipment.handling_fee || '',
                internal_notes: data.consolidateShipment.internal_notes || '',
                updated_at: data.consolidateShipment.updated_at || '',
                proof_of_delivery_path: data.consolidateShipment?.documents?.proof_of_delivery_path || '',
                documents: data.consolidateShipment?.documents?.map(doc => ({
                  id: doc.id,
                  file_path: doc.file_path
              })) || []
                

                
                //shipment_expenses: data.shipment_expenses || [],
              };
            })
            .catch(error => {
              console.error('Error fetching data:', error);
            })
            .finally(() => {
              this.isLoading = false;
            });
          }
        }));
      });

      function printDiv(divId) {
          const printContents = document.getElementById(divId).innerHTML;
          const originalContents = document.body.innerHTML;
          document.body.innerHTML = printContents;
          window.print();
          document.body.innerHTML = originalContents;
          location.reload();
      }
   
      </script>
  </body>
</html>
